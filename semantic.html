<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosistema Inteligente de Conocimiento para la Formación Judicial</title>
    
    <!-- CSS Framework -->
    <!-- CSS Framework -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- Icons and Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Cytoscape Extensions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-panzoom/2.5.3/cytoscape-panzoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-navigator/2.0.1/cytoscape-navigator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-dagre/2.5.0/cytoscape-dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-cose-bilkent/4.1.0/cytoscape-cose-bilkent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-cola/2.5.1/cytoscape-cola.min.js"></script>

    <!-- Highlight.js para resaltado de sintaxis -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>

        
    <!-- Data Sources -->
    <script src="data_todo.js"></script>
    <script src="data_c3.js"></script>

    <link href="estilos.css" rel="stylesheet">
    
    
</head>
<body>




    
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold">Coordinación Técnica - Modelado Ontológico y Planificación Asistida</h1>
                </div>
                <div class="flex items-center">
                    <span class="mr-4 text-sm">Escuela de Estudios Judiciales del Organismo Judicial de Guatemala · David Salazar, UNV | PNUD</span>
                    <button id="help-button" class="control-button">
                        <i class="fas fa-question-circle"></i> Ayuda
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="content-container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <!-- Search -->
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="Buscar cursos, competencias, conceptos...">
                    </div>
                </div>
                
                <!-- Mode Selector -->
                <div class="mode-selector">
                    <button class="mode-button active" data-mode="explore">
                        <i class="fas fa-globe"></i> Explorar
                    </button>
                    <button class="mode-button" data-mode="analyze">
                        <i class="fas fa-chart-bar"></i> Analizar
                    </button>
                    <button class="mode-button" data-mode="learning-path">
                        <i class="fas fa-route"></i> Rutas de Aprendizaje
                    </button>
                    <button class="mode-button" data-mode="report">
                        <i class="fas fa-file-alt"></i> Reportes
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="courses">Cursos</div>
                    <div class="tab" data-tab="competencies">Competencias</div>
                    <div class="tab" data-tab="concepts">Conceptos</div>
                </div>
                
                <!-- Tab Content -->
                <div id="courses-tab" class="tab-content active">
                    <!-- Filters -->
                    <div class="filter-container">
                        
                        <div class="filter-section">
                            <span class="filter-label">Filtrar por área:</span>
                            <div class="filter-options" id="area-filters">
                                <!-- Dynamically filled with JavaScript -->
                            </div>
                        </div>
                        <div class="filter-section">
                            <span class="filter-label">Filtrar por tipo:</span>
                            <div class="filter-options" id="type-filters">
                                <!-- Dynamically filled with JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Course List -->
                    <ul class="node-list" id="course-list">
                        <!-- Dynamically filled with JavaScript -->
                    </ul>
                </div>
                
                <div id="competencies-tab" class="tab-content">
                    <!-- Filters -->
                    <div class="filter-container">
                        <div class="filter-section">
                            <span class="filter-label">Filtrar por nivel:</span>
                            <div class="filter-options" id="level-filters">
                                <!-- Dynamically filled with JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Competency List -->
                    <ul class="node-list" id="competency-list">
                        <!-- Dynamically filled with JavaScript -->
                    </ul>
                </div>
                
                <div id="concepts-tab" class="tab-content">
                    <!-- Filters -->
                    <div class="filter-container">
                        <div class="filter-section">
                            <span class="filter-label">Filtrar por categoría:</span>
                            <div class="filter-options" id="category-filters">
                                <!-- Dynamically filled with JavaScript -->
                            </div>
                        </div>
                        <div class="filter-section">
                            <span class="filter-label">Filtrar por complejidad:</span>
                            <div class="filter-options" id="complexity-filters">
                                <!-- Dynamically filled with JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Concept List -->
                    <ul class="node-list" id="concept-list">
                        <!-- Dynamically filled with JavaScript -->
                    </ul>
                </div>
            </div>
            
            <!-- Sidebar Toggle -->
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-chevron-left" id="toggle-icon"></i>
            </button>
            
            <!-- Main Content Area -->
            <div class="main-content">
                <div class="visualization-area">
                    <!-- Graph Container -->
                    <div id="graph-container"></div>
                    
                    <!-- Navigator Container -->
                    <div id="minimap-container"></div>
                    
                    <!-- Controls Overlay -->
                    <div class="controls-overlay">
                        <button class="control-button" id="reset-view">
                            <i class="fas fa-home"></i> Reiniciar vista
                        </button>
                        <button class="control-button" id="fit-all">
                            <i class="fas fa-expand"></i> Ver todo
                        </button>
                        <button class="control-button" id="toggle-labels">
                            <i class="fas fa-tags"></i> Etiquetas
                        </button>
                        <button class="control-button" id="create-path-button">
                            <i class="fas fa-route"></i> Crear ruta
                        </button>
                        <!-- Añadir el botón de estadísticas aquí -->
                        <button class="control-button" id="show-stats">
                            <i class="fas fa-chart-pie"></i> Estadísticas
                        </button>
                    </div>
                    
                    <!-- Layout Controls -->
                    <div class="layout-controls">
                        <span class="mr-2 text-sm font-semibold">Diseño:</span>
                        <select id="layout-select" class="p-1 border border-gray-300 rounded text-sm">
                            <option value="cose">Orgánico</option>
                            <option value="breadthfirst">Jerárquico</option>
                            <option value="concentric">Concéntrico</option>
                            <option value="circle">Circular</option>
                            <option value="grid">Cuadrícula</option>
                            <option value="dagre">Árbol (Dagre)</option>
                            <option value="cose-bilkent">Orgánico Mejorado</option>
                        </select>
                    </div>
                    
                    <!-- Graph Legend -->
                    <div class="graph-legend">
                        <div class="legend-title">Leyenda:</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f59e0b;"></div>
                            <span>Cursos</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3b82f6;"></div>
                            <span>Competencias</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #10b981;"></div>
                            <span>Conceptos</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ef4444;"></div>
                            <span>Normativa</span>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div class="loading-spinner active" id="loading-spinner">
                        <div class="spinner"></div>
                        <div class="spinner-text">Cargando ecosistema de conocimiento...</div>
                    </div>
                    
                    <!-- Tooltip -->
                    <div class="tooltip" id="graph-tooltip"></div>



                    <!-- Statistics Panel -->
                    <div class="stats-panel" id="stats-panel">
                        <div class="stats-header">
                            <h2 id="stats-title" class="text-xl font-bold">Estadísticas del Ecosistema</h2>
                            <button class="close-button" id="close-stats">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="stats-content">
                            <div class="stats-section">
                                <h3 class="stats-section-title">Resumen General</h3>
                                <div class="stats-cards" id="general-stats">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                            
                            <div class="stats-section">
                                <h3 class="stats-section-title">Distribución por Áreas</h3>
                                <div class="chart-container">
                                    <canvas id="areas-chart"></canvas>
                                </div>
                            </div>
                            
                            <div class="stats-section">
                                <h3 class="stats-section-title">Distribución por Eje Formativo</h3>
                                <div class="chart-container">
                                    <canvas id="ejes-chart"></canvas>
                                </div>
                            </div>
                            
                            <div class="stats-section">
                                <h3 class="stats-section-title">Competencias por Nivel</h3>
                                <div class="chart-container">
                                    <canvas id="competencies-chart"></canvas>
                                </div>
                            </div>
                            
                            <div class="stats-section">
                                <h3 class="stats-section-title">Conceptos por Complejidad</h3>
                                <div class="chart-container">
                                    <canvas id="concepts-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detail Panel -->
                <div class="detail-panel" id="detail-panel">
                    <div class="detail-header">
                        <h2 id="detail-title" class="text-xl font-bold">Detalle</h2>
                        <button class="close-button" id="close-detail">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="tabs-container">
                        <div class="panel-tab active" data-panel="info">Información</div>
                        <div class="panel-tab" data-panel="relations">Relaciones</div>
                        <div class="panel-tab" data-panel="analysis">Análisis</div>
                        <div class="panel-tab" data-panel="json">JSON</div>
                    </div>
                    
                    <div id="info-panel" class="panel-content active">
                        <!-- Dynamically filled with JavaScript -->
                    </div>
                    
                    <div id="relations-panel" class="panel-content">
                        <!-- Dynamically filled with JavaScript -->
                    </div>
                    
                    <div id="analysis-panel" class="panel-content">
                        <!-- Dynamically filled with JavaScript -->
                    </div>
                    <div id="json-panel" class="panel-content">
                        <div class="p-4">
                            <h3 class="font-bold mb-3 text-primary">Datos JSON del Elemento</h3>
                            <div class="bg-gray-100 p-4 rounded overflow-auto max-h-[500px]">
                                <pre id="json-content" class="text-xs"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Ecosistema Inteligente de Conocimiento</h3>
                    <p>Herramienta para la visualización, análisis y gestión del conocimiento para la formación judicial en Guatemala, basada en modelos ontológicos y planificación asistida por IA.</p>
                </div>
                <div class="footer-section">
                    <h3>Enlaces de Interés</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-external-link-alt mr-2"></i>Escuela de Estudios Judiciales</a></li>
                        <li><a href="#"><i class="fas fa-external-link-alt mr-2"></i>Organismo Judicial</a></li>
                        <li><a href="#"><i class="fas fa-external-link-alt mr-2"></i>Documentación</a></li>
                        <li><a href="#"><i class="fas fa-external-link-alt mr-2"></i>Contacto</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Acerca del Proyecto</h3>
                    <p>Desarrollado como parte de la iniciativa de modernización de la formación judicial. Versión 1.0 - 2025.</p>
                    <p class="mt-2"><strong>Coordinación:</strong> David Salazar, UNV | PNUD</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Organismo Judicial de Guatemala. Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Ayuda del Ecosistema Inteligente de Conocimiento</h3>
                <button class="modal-close" id="help-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="overview">Introducción</div>
                    <div class="modal-tab" data-tab="navigation">Navegación</div>
                    <div class="modal-tab" data-tab="visualization">Visualización</div>
                    <div class="modal-tab" data-tab="path">Rutas de Aprendizaje</div>
                </div>
                
                <div class="modal-tab-content active" id="overview-tab">
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-info-circle"></i> ¿Qué es el Ecosistema Inteligente?
                        </div>
                        <div class="help-content">
                            <p class="mb-3">El Ecosistema Inteligente de Conocimiento para la Formación Judicial es una herramienta avanzada que integra la planificación educativa asistida por IA con un sistema ontológico para la gestión del conocimiento judicial.</p>
                            <p>Esta plataforma permite visualizar, analizar y gestionar la estructura de cursos, competencias y conceptos jurídicos, facilitando la creación de rutas de aprendizaje personalizadas y el análisis estratégico del panorama formativo institucional.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-layer-group"></i> Componentes Principales
                        </div>
                        <div class="help-content">
                            <div class="welcome-feature">
                                <div class="welcome-feature-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div class="welcome-feature-content">
                                    <div class="welcome-feature-title">Visualización del Conocimiento</div>
                                    <div class="welcome-feature-text">Explora la visualización interactiva del ecosistema de conocimiento, mostrando las relaciones entre cursos, competencias, conceptos y normativa.</div>
                                </div>
                            </div>
                            
                            <div class="welcome-feature">
                                <div class="welcome-feature-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="welcome-feature-content">
                                    <div class="welcome-feature-title">Análisis Estratégico</div>
                                    <div class="welcome-feature-text">Analiza la cobertura temática, la distribución de complejidad y las relaciones entre conceptos y competencias para identificar oportunidades de mejora.</div>
                                </div>
                            </div>
                            
                            <div class="welcome-feature">
                                <div class="welcome-feature-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="welcome-feature-content">
                                    <div class="welcome-feature-title">Rutas de Aprendizaje</div>
                                    <div class="welcome-feature-text">Crea y personaliza rutas de aprendizaje adaptadas a diferentes perfiles profesionales y necesidades específicas.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-tab-content" id="navigation-tab">
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-compass"></i> Navegación Básica
                        </div>
                        <div class="help-content">
                            <p class="mb-2">El ecosistema ofrece varias formas de interactuar con la información:</p>
                            <ul class="list-disc ml-5 mb-3">
                                <li><strong>Barra Lateral:</strong> Explora y filtra por cursos, competencias y conceptos</li>
                                <li><strong>Visualización Central:</strong> Interactúa con el grafo de conocimiento</li>
                                <li><strong>Panel de Detalles:</strong> Visualiza información completa de cada elemento</li>
                                <li><strong>Modos:</strong> Explora, Analiza, Crea Rutas o Genera Reportes</li>
                            </ul>
                            <p>Puedes ocultar/mostrar la barra lateral con el botón <i class="fas fa-chevron-left"></i> para tener más espacio para la visualización.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-filter"></i> Filtros y Búsqueda
                        </div>
                        <div class="help-content">
                            <p>La barra de búsqueda te permite encontrar rápidamente cualquier elemento en el ecosistema.</p>
                            <p>Los filtros te permiten explorar por:</p>
                            <ul class="list-disc ml-5 mt-2">
                                <li><strong>Área:</strong> Temática principal de los cursos</li>
                                <li><strong>Tipo:</strong> Categoría de la actividad formativa</li>
                                <li><strong>Nivel:</strong> Dificultad o complejidad</li>
                                <li><strong>Categoría:</strong> Clasificación conceptual</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-sync-alt"></i> Cambio de Modos
                        </div>
                        <div class="help-content">
                            <p>El sistema ofrece diferentes modos para trabajar con la información:</p>
                            <ul class="list-disc ml-5 mt-2">
                                <li><strong>Explorar:</strong> Visualiza y navega por el ecosistema completo</li>
                                <li><strong>Analizar:</strong> Obtén insights sobre la estructura formativa</li>
                                <li><strong>Rutas de Aprendizaje:</strong> Crea itinerarios personalizados</li>
                                <li><strong>Reportes:</strong> Genera informes sobre diferentes aspectos</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="modal-tab-content" id="visualization-tab">
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-project-diagram"></i> Grafo de Conocimiento
                        </div>
                        <div class="help-content">
                            <p class="mb-3">El grafo central muestra las relaciones entre todos los elementos del ecosistema:</p>
                            <ul class="list-disc ml-5 mb-3">
                                <li><strong style="color: #f59e0b;">Cursos:</strong> Actividades formativas (naranja)</li>
                                <li><strong style="color: #3b82f6;">Competencias:</strong> Habilidades a desarrollar (azul)</li>
                                <li><strong style="color: #10b981;">Conceptos:</strong> Unidades de conocimiento (verde)</li>
                                <li><strong style="color: #ef4444;">Normativa:</strong> Marcos legales y regulatorios (rojo)</li>
                            </ul>
                            <p>Las líneas muestran relaciones entre elementos, como "desarrolla", "incluye", "regulado por", etc.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-mouse"></i> Interacción con el Grafo
                        </div>
                        <div class="help-content">
                            <p>Puedes interactuar con el grafo de varias formas:</p>
                            <ul class="list-disc ml-5 mb-2 mt-2">
                                <li><strong>Clic:</strong> Selecciona un nodo para ver sus detalles</li>
                                <li><strong>Arrastrar:</strong> Mueve el grafo o reposiciona nodos</li>
                                <li><strong>Zoom:</strong> Usa la rueda del ratón o gestos multitáctiles</li>
                                <li><strong>Minimap:</strong> Utiliza el mapa miniatura para la navegación</li>
                            </ul>
                            <p>Al hacer clic en un elemento, se destacarán sus conexiones directas, facilitando la visualización de relaciones.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-sliders-h"></i> Controles de Visualización
                        </div>
                        <div class="help-content">
                            <p>La barra de controles te permite modificar la visualización:</p>
                            <ul class="list-disc ml-5 mt-2">
                                <li><strong>Reiniciar Vista:</strong> Vuelve a la posición inicial</li>
                                <li><strong>Ver Todo:</strong> Ajusta el zoom para mostrar todos los elementos</li>
                                <li><strong>Etiquetas:</strong> Muestra/oculta las etiquetas de los nodos</li>
                                <li><strong>Diseño:</strong> Cambia la distribución de los nodos (jerárquico, orgánico, etc.)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="modal-tab-content" id="path-tab">
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-route"></i> Creación de Rutas de Aprendizaje
                        </div>
                        <div class="help-content">
                            <p class="mb-3">Las rutas de aprendizaje permiten definir secuencias personalizadas de formación para diferentes perfiles y objetivos.</p>
                            <p class="mb-2">Para crear una ruta:</p>
                            <ol class="list-decimal ml-5 mb-3">
                                <li>Haz clic en el botón <i class="fas fa-route"></i> <strong>Crear ruta</strong></li>
                                <li>Selecciona un perfil profesional (Juez de Paz, Primera Instancia, etc.)</li>
                                <li>Elige el área de interés para la especialización</li>
                                <li>Ajusta la duración y otros parámetros</li>
                                <li>Genera la ruta personalizada</li>
                                <li>Visualiza, ajusta y guarda la ruta creada</li>
                            </ol>
                            <p>El sistema te mostrará una progresión lógica desde conceptos básicos hasta avanzados.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-lightbulb"></i> Recomendaciones Inteligentes
                        </div>
                        <div class="help-content">
                            <p>El sistema genera recomendaciones basadas en:</p>
                            <ul class="list-disc ml-5 mt-2">
                                <li><strong>Perfil profesional:</strong> Funciones y responsabilidades específicas</li>
                                <li><strong>Análisis de competencias:</strong> Habilidades necesarias para el perfil</li>
                                <li><strong>Prerrequisitos:</strong> Conocimientos previos necesarios</li>
                                <li><strong>Progresión de complejidad:</strong> Secuencia lógica desde conceptos básicos a avanzados</li>
                                <li><strong>Cobertura temática:</strong> Inclusión de todos los aspectos relevantes</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <div class="help-title">
                            <i class="fas fa-share-alt"></i> Compartir y Exportar Rutas
                        </div>
                        <div class="help-content">
                            <p>Una vez creada una ruta, puedes:</p>
                            <ul class="list-disc ml-5 mt-2">
                                <li><strong>Guardarla</strong> para acceder posteriormente</li>
                                <li><strong>Exportarla</strong> como PDF o archivo de datos</li>
                                <li><strong>Compartirla</strong> con otros usuarios mediante un enlace</li>
                                <li><strong>Modificarla</strong> para ajustarla a necesidades específicas</li>
                            </ul>
                            <p>Las rutas guardadas aparecen en tu sección de "Mis Rutas" para fácil acceso.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="help-modal-understand">
                    <i class="fas fa-check"></i> Entendido
                </button>
            </div>
        </div>
    </div>
    
    <!-- Welcome Modal -->
    <div class="modal-overlay active" id="welcome-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Bienvenido al Ecosistema Inteligente de Conocimiento</h3>
                <button class="modal-close" id="welcome-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Este sistema integra la planificación educativa asistida por IA con un modelo ontológico para la gestión del conocimiento judicial, facilitando la visualización, análisis y personalización de la formación judicial en Guatemala.</p>
                
                <div class="welcome-feature fade-in" style="animation-delay: 0.2s">
                    <div class="welcome-feature-icon pulse-animation">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div class="welcome-feature-content">
                        <div class="welcome-feature-title">Visualización del Conocimiento</div>
                        <div class="welcome-feature-text">Explora la estructura interconectada de cursos, competencias y conceptos jurídicos a través de una visualización interactiva.</div>
                    </div>
                </div>
                
                <div class="welcome-feature fade-in" style="animation-delay: 0.4s">
                    <div class="welcome-feature-icon pulse-animation">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="welcome-feature-content">
                        <div class="welcome-feature-title">Búsqueda y Filtrado</div>
                        <div class="welcome-feature-text">Encuentra rápidamente la información que necesitas con potentes herramientas de búsqueda y filtrado.</div>
                    </div>
                </div>
                
                <div class="welcome-feature fade-in" style="animation-delay: 0.6s">
                    <div class="welcome-feature-icon pulse-animation">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="welcome-feature-content">
                        <div class="welcome-feature-title">Análisis Estratégico</div>
                        <div class="welcome-feature-text">Obtén insights y recomendaciones basadas en el análisis de la estructura formativa.</div>
                    </div>
                </div>
                
                <div class="welcome-feature fade-in" style="animation-delay: 0.8s">
                    <div class="welcome-feature-icon pulse-animation">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="welcome-feature-content">
                        <div class="welcome-feature-title">Rutas de Aprendizaje</div>
                        <div class="welcome-feature-text">Crea y personaliza rutas formativas adaptadas a diferentes perfiles profesionales y necesidades.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="welcome-modal-start">
                    <i class="fas fa-play"></i> Comenzar a explorar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Learning Path Modal -->
    <div class="modal-overlay" id="learning-path-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Crear Ruta de Aprendizaje Personalizada</h3>
                <button class="modal-close" id="learning-path-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Perfil Profesional:</label>
                    <select id="profile-selector" class="w-full p-2 border border-gray-300 rounded">
                        <option value="juez_paz">Juez/a de Paz</option>
                        <option value="juez_primera">Juez/a de Primera Instancia</option>
                        <option value="magistrado">Magistrado/a</option>
                        <option value="auxiliar">Personal Auxiliar</option>
                        <option value="administrativo">Personal Administrativo</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Área de Interés:</label>
                    <select id="area-selector" class="w-full p-2 border border-gray-300 rounded">
                        <option value="all">Todas las Áreas</option>
                        <!-- Será llenado dinámicamente con JavaScript -->
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Duración Recomendada:</label>
                    <div class="flex items-center">
                        <input type="range" id="duration-slider" min="1" max="12" value="6" class="w-full">
                        <span id="duration-value" class="ml-2">6 meses</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Enfoque Especial (opcional):</label>
                    <div class="flex flex-wrap gap-2 mt-1">
                        <span class="badge badge-primary cursor-pointer" data-focus="practico">Enfoque Práctico</span>
                        <span class="badge badge-secondary cursor-pointer" data-focus="teorico">Enfoque Teórico</span>
                        <span class="badge badge-info cursor-pointer" data-focus="especializado">Especialización</span>
                        <span class="badge badge-success cursor-pointer" data-focus="integral">Formación Integral</span>
                    </div>
                </div>
                
                <button id="generate-path-btn" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-opacity-90 flex items-center justify-center font-medium">
                    <i class="fas fa-magic mr-2"></i> Generar Ruta de Aprendizaje
                </button>
                
                <div id="path-result-container" class="mt-6 hidden">
                    <h4 class="font-semibold mb-3">Su Ruta de Aprendizaje Personalizada:</h4>
                    
                    <div class="mb-4">
                        <div class="bg-primary text-white py-2 px-3 rounded-t font-medium">Nivel Básico</div>
                        <div id="basic-level-container" class="border border-gray-300 border-t-0 p-3 rounded-b space-y-3">
                            <!-- Será llenado dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="learning-path-connector">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    
                    <div class="mb-4">
                        <div class="bg-primary text-white py-2 px-3 rounded-t font-medium">Nivel Intermedio</div>
                        <div id="intermediate-level-container" class="border border-gray-300 border-t-0 p-3 rounded-b space-y-3">
                            <!-- Será llenado dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="learning-path-connector">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    
                    <div class="mb-4">
                        <div class="bg-primary text-white py-2 px-3 rounded-t font-medium">Nivel Avanzado</div>
                        <div id="advanced-level-container" class="border border-gray-300 border-t-0 p-3 rounded-b space-y-3">
                            <!-- Será llenado dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-100 rounded">
                        <h5 class="font-semibold mb-1">Resumen de la ruta:</h5>
                        <p id="path-summary" class="text-sm"></p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500">Esta ruta ha sido generada en base a su perfil y preferencias.</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="path-modal-footer">
                <button class="btn-outline mr-2" id="path-modal-save" disabled>
                    <i class="fas fa-save"></i> Guardar Ruta
                </button>
                <button class="btn-outline mr-2" id="path-modal-export" disabled>
                    <i class="fas fa-file-export"></i> Exportar PDF
                </button>
                <button class="btn-primary" id="path-modal-close">
                    <i class="fas fa-check"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">Título de la notificación</div>
            <div class="notification-message">Mensaje de la notificación</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // External data sources
        console.log('Checking for external data...');
        
        // Wait for document to load
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load external scripts
            loadExternalScripts()
                .then(() => {
                    // Initialize the application once scripts are loaded
                    initializeApp();
                })
                .catch(error => {
                    handleScriptLoadError(error);
                });
                
            // Initialize UI components that don't depend on data
            initializeTabs();
            initializeModals();
        });
        
        // Function to load external scripts
        function loadExternalScripts() {
    return new Promise((resolve, reject) => {
        // Check if data is already available from the script tags
        if (typeof dataTodo !== 'undefined' && typeof dataC3 !== 'undefined') {
            console.log('Data already loaded from script tags');
            resolve();
            return;
        }
        
        // If we get here, the data wasn't loaded via script tags, so load it programmatically
        console.log('Data not found, attempting to load scripts programmatically...');
        
        const c12Script = document.createElement('script');
        c12Script.src = 'c12.js';
        c12Script.onload = function() {
            console.log('c12.js loaded successfully');
            
            const c3Script = document.createElement('script');
            c3Script.src = 'c3.js';
            c3Script.onload = function() {
                console.log('c3.js loaded successfully');
                resolve();
            };
            c3Script.onerror = function() {
                reject(new Error('Failed to load c3.js'));
            };
            document.head.appendChild(c3Script);
        };
        c12Script.onerror = function() {
            reject(new Error('Failed to load c12.js'));
        };
        document.head.appendChild(c12Script);
    });
}
        
        // Handle script load error
        function handleScriptLoadError(error) {
            console.error('Error loading external scripts:', error);
            
            // Get graph container
            const graphContainer = document.getElementById('graph-container');
            
            // Display error message
            graphContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-white p-6 rounded-lg shadow">
                    <div class="text-2xl text-red-600 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Error de carga de datos</div>
                    <div class="text-center max-w-lg">
                        No se pudieron cargar los archivos de datos externos (c12.js y c3.js). 
                        Verifique que los archivos existen en la ruta correcta y contienen los datos esperados con la estructura correcta.
                    </div>
                    <div class="mt-4">
                        <button class="btn-primary" onclick="location.reload()">
                            <i class="fas fa-sync-alt mr-2"></i>Reintentar
                        </button>
                    </div>
                </div>
            `;
            
            // Hide loading spinner
            document.getElementById('loading-spinner').classList.remove('active');
        }
        
        // Initialize tabs (sidebar tabs and detail panel tabs)
        function initializeTabs() {
            // Sidebar tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Get the tab ID
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to this tab
                    this.classList.add('active');
                    
                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show this tab's content
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Detail panel tabs
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Get the panel ID
                    const panelId = this.getAttribute('data-panel');
                    
                    // Remove active class from all panel tabs
                    document.querySelectorAll('.panel-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to this panel tab
                    this.classList.add('active');
                    
                    // Hide all panel content
                    document.querySelectorAll('.panel-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show this panel's content
                    document.getElementById(`${panelId}-panel`).classList.add('active');
                });
            });
            
            // Modal tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Get the tab ID
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all modal tabs
                    document.querySelectorAll('.modal-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to this modal tab
                    this.classList.add('active');
                    
                    // Hide all modal tab content
                    document.querySelectorAll('.modal-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show this modal tab's content
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        // Initialize modals
        function initializeModals() {
            // Welcome modal
            const welcomeModal = document.getElementById('welcome-modal');
            const welcomeModalClose = document.getElementById('welcome-modal-close');
            const welcomeModalStart = document.getElementById('welcome-modal-start');
            
            welcomeModalClose.addEventListener('click', function() {
                welcomeModal.classList.remove('active');
            });
            
            welcomeModalStart.addEventListener('click', function() {
                welcomeModal.classList.remove('active');
            });
            
            // Help modal
            const helpModal = document.getElementById('help-modal');
            const helpModalClose = document.getElementById('help-modal-close');
            const helpModalUnderstand = document.getElementById('help-modal-understand');
            const helpButton = document.getElementById('help-button');
            
            helpButton.addEventListener('click', function() {
                helpModal.classList.add('active');
            });
            
            helpModalClose.addEventListener('click', function() {
                helpModal.classList.remove('active');
            });
            
            helpModalUnderstand.addEventListener('click', function() {
                helpModal.classList.remove('active');
            });
            
            // Learning path modal
            const learningPathModal = document.getElementById('learning-path-modal');
            const learningPathModalClose = document.getElementById('learning-path-modal-close');
            const pathModalClose = document.getElementById('path-modal-close');
            const createPathButton = document.getElementById('create-path-button');
            
            createPathButton.addEventListener('click', function() {
                openLearningPathModal();
            });
            
            learningPathModalClose.addEventListener('click', function() {
                learningPathModal.classList.remove('active');
            });
            
            pathModalClose.addEventListener('click', function() {
                learningPathModal.classList.remove('active');
            });
            
            // Duration slider
            const durationSlider = document.getElementById('duration-slider');
            const durationValue = document.getElementById('duration-value');
            
            durationSlider.addEventListener('input', function() {
                durationValue.textContent = `${this.value} meses`;
            });
            
            // Generate path button
            const generatePathBtn = document.getElementById('generate-path-btn');
            
            generatePathBtn.addEventListener('click', function() {
                generateLearningPath();
            });
            
            // Focus badges
            document.querySelectorAll('.badge[data-focus]').forEach(badge => {
                badge.addEventListener('click', function() {
                    // Toggle active class
                    this.classList.toggle('badge-primary');
                    this.classList.toggle('badge-secondary');
                });
            });
        }
        
        // Initialize the application
        // Add this to the DOMContentLoaded event handler
window.onerror = function(message, source, lineno, colno, error) {
    console.error('Global error caught:', error);
    showNotification(
        'Error en la Aplicación',
        'Ha ocurrido un error inesperado. Por favor, recargue la página.',
        'error'
    );
    return true; // Prevents default error handling
};

// Initialize the application once scripts are loaded
function initializeApp() {
    try {
        // Show loading spinner
        document.getElementById('loading-spinner').classList.add('active');
        
        // Process data from external files
        const processedData = processData();
        
        // Validate processed data
        if (processedData.nodes.length === 0) {
            throw new Error('No se pudieron procesar datos de los archivos externos');
        }
        
        // Initialize Cytoscape
        const cytoscapeInitialized = initializeCytoscape(processedData);
        
        if (cytoscapeInitialized) {
            // Only continue with these if Cytoscape initialized successfully
            // Initialize filters
            initializeFilters(processedData);
            
            // Populate lists
            populateLists(processedData);
            
            // Initialize sidebar
            initializeSidebar();
            
            // Initialize search
            initializeSearch(processedData);
            
            // Initialize mode switching
            initializeModeSwitching(processedData);
        }
        
        // Hide loading spinner
        setTimeout(() => {
            document.getElementById('loading-spinner').classList.remove('active');
            
            // Show notification
            if (cytoscapeInitialized) {
                showNotification(
                    'Ecosistema de Conocimiento cargado',
                    'Se han cargado correctamente todos los datos del ecosistema de conocimiento.',
                    'success'
                );
            } else {
                showNotification(
                    'Carga parcial',
                    'Los datos fueron procesados pero la visualización no pudo inicializarse correctamente.',
                    'warning'
                );
            }
        }, 1500);
    } catch (error) {
        console.error('Error initializing application:', error);
        document.getElementById('loading-spinner').classList.remove('active');
        
        // Show error in graph container
        const graphContainer = document.getElementById('graph-container');
        graphContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full bg-white p-6 rounded-lg shadow">
                <div class="text-2xl text-red-600 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Error de inicialización</div>
                <div class="text-center max-w-lg">
                    No se pudo inicializar la aplicación: ${error.message}
                </div>
                <div class="mt-4">
                    <button class="btn-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt mr-2"></i>Reintentar
                    </button>
                </div>
            </div>
        `;
        
        // Show notification
        showNotification(
            'Error de inicialización',
            'No se pudo inicializar la aplicación: ' + error.message,
            'error'
        );
    }

    initializeStatsPanel();
}
        
function processData() {
    console.log('Processing data from external files...');
    
    // Create empty processed data structure
    const processedData = {
        nodes: [],
        edges: [],
        courses: [],
        competencies: [],
        concepts: [],
        normative: [],
        areas: [],
        types: [],
        levels: [],
        categories: [],
        complexities: []
    };
    
    try {
        // Validate that data exists
        if (typeof dataTodo === 'undefined' || typeof dataC3 === 'undefined') {
            throw new Error('Data variables (dataTodo or dataC3) are not defined');
        }

        console.log('Data sources available:', 
                   'dataTodo:', Array.isArray(dataTodo) ? dataTodo.length : 'not an array', 
                   'dataC3:', Array.isArray(dataC3) ? dataC3.length : 'not an array');
        
        // Debug data structure
        console.log('Sample data structure - dataTodo[0]:', dataTodo[0]);
        console.log('Sample data structure - dataC3[0]:', dataC3[0]);
        
        // Process capa1 and capa2 data (from dataTodo)
        if (Array.isArray(dataTodo) && dataTodo.length > 0) {
            // Extract courses (capa1) - items with 'codigo' and 'objetivo' properties
            const courses = dataTodo.filter(item => item.codigo && item.objetivo);
            console.log('Extracted courses:', courses.length);
            
            // Extract metadata (capa2) - items without 'codigo' but with 'eje_formativo'
            const metadata = dataTodo.filter(item => !item.codigo && item.eje_formativo);
            console.log('Extracted metadata:', metadata.length);
            
            // Process courses
            courses.forEach((course, index) => {
                // Create course node
                const courseNode = {
                    id: course.codigo || `course-${index}`,
                    type: 'course',
                    label: course.codigo ? course.codigo.split('-').pop() : `C${index}`,
                    name: course.actividad || `Curso ${index}`,
                    data: course
                };
                
                // Add to nodes
                processedData.nodes.push(courseNode);
                
                // Add to courses
                processedData.courses.push(courseNode);
                
                // Extract areas, types, levels
                if (course.area_organizativa_pfjya && !processedData.areas.includes(course.area_organizativa_pfjya)) {
                    processedData.areas.push(course.area_organizativa_pfjya);
                }
                
                if (course.tipo_formacion && !processedData.types.includes(course.tipo_formacion)) {
                    processedData.types.push(course.tipo_formacion);
                }
                
                if (course.nivel_dificultad && !processedData.levels.includes(course.nivel_dificultad)) {
                    processedData.levels.push(course.nivel_dificultad);
                }
                
                // Find corresponding metadata for this course
                const meta = metadata.find(m => {
                    // For demonstration, assuming courses and metadata match by eje_formativo
                    return m.eje_formativo === course.eje_formativo;
                });
                
                // Process competencies if metadata exists
                if (meta && meta.competencias_profesionales_asociadas) {
                    meta.competencias_profesionales_asociadas.forEach((competencia, compIndex) => {
                        // Create competency ID
                        const competencyId = `${course.codigo}-C${compIndex + 1}`;
                        
                        // Create competency node
                        const competencyNode = {
                            id: competencyId,
                            type: 'competency',
                            label: `C${compIndex + 1}`,
                            name: truncateText(competencia, 50),
                            data: {
                                competencia: competencia,
                                courseId: course.codigo,
                                nivel: course.nivel_dificultad || 'No especificado',
                                areas_asociadas: meta.areas_juridicas_principales || []
                            }
                        };
                        
                        // Add to nodes
                        processedData.nodes.push(competencyNode);
                        
                        // Add to competencies
                        processedData.competencies.push(competencyNode);
                        
                        // Create edge from course to competency
                        processedData.edges.push({
                            id: `${course.codigo}_${competencyId}`,
                            source: course.codigo,
                            target: competencyId,
                            label: 'desarrolla'
                        });
                        
                        // Extract categories
                        if (meta.areas_juridicas_principales) {
                            meta.areas_juridicas_principales.forEach(area => {
                                if (!processedData.categories.includes(area)) {
                                    processedData.categories.push(area);
                                }
                            });
                        }
                    });
                }
            });
        }
        
        // Process capa3 data (from dataC3)
        if (Array.isArray(dataC3) && dataC3.length > 0) {
            dataC3.forEach((concept, index) => {
                // Ensure concept has an ID
                const conceptId = concept.ID_Nodo_Conceptual || `concept-${index}`;
                
                // Create concept node
                const conceptNode = {
                    id: conceptId,
                    type: 'concept',
                    label: conceptId.split('-').pop(),
                    name: concept.concepto_principal || `Concepto ${index}`,
                    data: concept
                };
                
                // Add to nodes
                processedData.nodes.push(conceptNode);
                
                // Add to concepts
                processedData.concepts.push(conceptNode);
                
                // Extract complexities
                if (concept.nivel_complejidad_conceptual && !processedData.complexities.includes(concept.nivel_complejidad_conceptual)) {
                    processedData.complexities.push(concept.nivel_complejidad_conceptual);
                }
                
                // Connect to competencies
                if (concept.competencias_profesionales_asociadas) {
                    concept.competencias_profesionales_asociadas.forEach(competencyId => {
                        // Check if competency exists
                        const competencyExists = processedData.nodes.some(node => node.id === competencyId);
                        
                        if (competencyExists) {
                            // Create edge from concept to competency
                            processedData.edges.push({
                                id: `${conceptId}_${competencyId}`,
                                source: conceptId,
                                target: competencyId,
                                label: 'apoya'
                            });
                        }
                    });
                }
                
                // Connect to activities
                if (concept.actividades_formativas_vinculadas) {
                    concept.actividades_formativas_vinculadas.forEach(activityId => {
                        // Check if activity exists
                        const activityExists = processedData.nodes.some(node => node.id === activityId);
                        
                        if (activityExists) {
                            // Create edge from concept to activity
                            processedData.edges.push({
                                id: `${conceptId}_${activityId}`,
                                source: conceptId,
                                target: activityId,
                                label: 'incluye'
                            });
                        }
                    });
                }
                
                // Connect to related concepts
                if (concept.relaciones_semanticas) {
                    concept.relaciones_semanticas.forEach(relation => {
                        if (relation.concepto_relacionado_id) {
                            // Create edge from concept to related concept
                            processedData.edges.push({
                                id: `${conceptId}_${relation.concepto_relacionado_id}`,
                                source: conceptId,
                                target: relation.concepto_relacionado_id,
                                label: relation.tipo
                            });
                        }
                    });
                }
                
                // Process normative references
                if (concept.referencias_legales) {
                    concept.referencias_legales.forEach((ref, refIndex) => {
                        // Create normative ID
                        const normativeId = `NORM-${conceptId}-${refIndex}`;
                        
                        // Create normative node
                        const normativeNode = {
                            id: normativeId,
                            type: 'normative',
                            label: ref.fuente ? ref.fuente.split(' ')[0] : 'Ref', // Short label
                            name: `${ref.fuente || 'Normativa'} ${ref.articulo ? '- Art. ' + ref.articulo : ''}`,
                            data: ref
                        };
                        
                        // Add to nodes
                        processedData.nodes.push(normativeNode);
                        
                        // Add to normative
                        processedData.normative.push(normativeNode);
                        
                        // Create edge from concept to normative
                        processedData.edges.push({
                            id: `${conceptId}_${normativeId}`,
                            source: conceptId,
                            target: normativeId,
                            label: 'reguladoPor'
                        });
                    });
                }
            });
        }
        
        console.log('Data processing complete. Generated:', 
                  processedData.nodes.length, 'nodes,', 
                  processedData.edges.length, 'edges,',
                  processedData.courses.length, 'courses,',
                  processedData.competencies.length, 'competencies,',
                  processedData.concepts.length, 'concepts');
        
        if (processedData.nodes.length === 0) {
            throw new Error('No se pudieron extraer datos de la estructura proporcionada');
        }
        
        return processedData;
    } catch (error) {
        console.error('Error processing data:', error);
        throw error;
    }
}
        
function initializeCytoscape(data) {
    console.log('Initializing Cytoscape with data structure:', data);
    
    // Register Cytoscape extensions
    try {
        // Register layout extensions
        if (typeof cytoscapeDagre !== 'undefined') {
            cytoscape.use(cytoscapeDagre);
        }
        if (typeof cytoscapeCoseBilkent !== 'undefined') {
            cytoscape.use(cytoscapeCoseBilkent);
        }
        if (typeof cytoscapeCola !== 'undefined') {
            cytoscape.use(cytoscapeCola);
        }
        if (typeof cytoscapePanzoom !== 'undefined') {
            cytoscape.use(cytoscapePanzoom);
        }
        if (typeof cytoscapeNavigator !== 'undefined') {
            cytoscape.use(cytoscapeNavigator);
        }
        console.log('Cytoscape extensions registered');
    } catch (e) {
        console.warn('Failed to register some Cytoscape extensions:', e);
    }
    
    // Create Cytoscape instance with error handling
    try {
        // Filter edges to only include those with existing targets and sources
        const validEdges = data.edges.filter(edge => {
            const sourceExists = data.nodes.some(node => node.id === edge.source);
            const targetExists = data.nodes.some(node => node.id === edge.target);
            return sourceExists && targetExists;
        });
        
        if (validEdges.length < data.edges.length) {
            console.warn(`Filtered out ${data.edges.length - validEdges.length} edges with missing targets or sources`);
        }
        
        // Initialize Cytoscape with valid edges only
        window.cy = cytoscape({
            container: document.getElementById('graph-container'),
            elements: {
                nodes: data.nodes.map(node => ({
                    data: {
                        id: node.id,
                        label: node.label,
                        name: node.name,
                        type: node.type,
                        nodeData: node.data
                    }
                })),
                edges: validEdges.map(edge => ({
                    data: {
                        id: edge.id,
                        source: edge.source,
                        target: edge.target,
                        label: edge.label
                    }
                }))
            },
            style: [
                // Node styles
                {
                    selector: 'node',
                    style: {
                        'background-color': '#666',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '10px',
                        'color': '#fff',
                        'text-outline-width': 1,
                        'text-outline-color': '#333',
                        'width': '30px',
                        'height': '30px',
                        'border-width': 1,
                        'border-color': '#fff'
                    }
                },
                // Course nodes
                {
                    selector: 'node[type = "course"]',
                    style: {
                        'background-color': '#f59e0b',
                        'shape': 'roundrectangle',
                        'width': '40px',
                        'height': '40px',
                        'text-outline-color': '#d97706'
                    }
                },
                // Competency nodes
                {
                    selector: 'node[type = "competency"]',
                    style: {
                        'background-color': '#3b82f6',
                        'shape': 'ellipse',
                        'text-outline-color': '#1e40af'
                    }
                },
                // Concept nodes
                {
                    selector: 'node[type = "concept"]',
                    style: {
                        'background-color': '#10b981',
                        'shape': 'hexagon',
                        'text-outline-color': '#059669'
                    }
                },
                // Normative nodes
                {
                    selector: 'node[type = "normative"]',
                    style: {
                        'background-color': '#ef4444',
                        'shape': 'diamond',
                        'width': '25px',
                        'height': '25px',
                        'text-outline-color': '#b91c1c'
                    }
                },
                // Edge styles
                {
                    selector: 'edge',
                    style: {
                        'width': 1.5,
                        'line-color': '#9ca3af',
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#9ca3af',
                        'opacity': 0.7
                    }
                },
                // Edge types
                {
                    selector: 'edge[label = "desarrolla"]',
                    style: {
                        'line-color': '#3b82f6',
                        'target-arrow-color': '#3b82f6'
                    }
                },
                {
                    selector: 'edge[label = "apoya"]',
                    style: {
                        'line-color': '#10b981',
                        'target-arrow-color': '#10b981'
                    }
                },
                {
                    selector: 'edge[label = "incluye"]',
                    style: {
                        'line-color': '#f59e0b',
                        'target-arrow-color': '#f59e0b'
                    }
                },
                {
                    selector: 'edge[label = "reguladoPor"]',
                    style: {
                        'line-color': '#ef4444',
                        'target-arrow-color': '#ef4444'
                    }
                },
                // Highlighted elements
                {
                    selector: '.highlighted',
                    style: {
                        'border-width': 2,
                        'border-color': '#f59e0b',
                        'border-opacity': 1,
                        'opacity': 1,
                        'text-outline-color': '#000',
                        'z-index': 9999
                    }
                },
                {
                    selector: '.faded',
                    style: {
                        'opacity': 0.15
                    }
                },
                {
                    selector: 'edge.highlighted',
                    style: {
                        'width': 3,
                        'opacity': 1,
                        'z-index': 9999
                    }
                },
                // Hidden elements
                {
                    selector: '.hidden',
                    style: {
                        'display': 'none'
                    }
                }
            ],
            layout: {
                name: 'cose',
                nodeDimensionsIncludeLabels: true,
                padding: 50,
                animate: false,
                randomize: true,
                componentSpacing: 100,
                nodeRepulsion: 4500,
                idealEdgeLength: 100,
                edgeElasticity: 100,
                nestingFactor: 1.2,
                gravity: 80,
                numIter: 1000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0
            },
            wheelSensitivity: 0.3
        });
        
        // Add node click event
        cy.on('tap', 'node', function(event) {
            const node = event.target;
            highlightNode(node);
            showNodeDetail(node);
        });
        
        // Add node hover event
        cy.on('mouseover', 'node', function(event) {
            const node = event.target;
            showTooltip(node);
        });
        
        cy.on('mouseout', 'node', function() {
            hideTooltip();
        });
        
        // Initialize controls
        initializeControls();
        
        // Add minimap/navigator
        try {
            const navigator = cy.navigator({
                container: document.getElementById('minimap-container'),
                viewLiveFramerate: 0,
                thumbnailEventFramerate: 30,
                thumbnailLiveFramerate: 0,
                dblClickDelay: 200
            });
        } catch (e) {
            console.warn('Navigator initialization failed:', e);
        }
        
        // Initialize panzoom control
        try {
            cy.panzoom({
                zoomFactor: 0.05,
                zoomDelay: 45,
                minZoom: 0.1,
                maxZoom: 3,
                fitPadding: 50,
                panSpeed: 10,
                panDistance: 10,
                panDragAreaSize: 75,
                panMinPercentSpeed: 0.25,
                panInactiveArea: 8,
                panIndicatorMinOpacity: 0.5,
                autodisableForMobile: true,
                zoomOnly: false,
                fitSelector: undefined,
                animateOnFit: function() {
                    return false;
                },
                fitAnimationDuration: 1000,
            });
        } catch (e) {
            console.warn('Panzoom initialization failed:', e);
        }
        
        console.log('Cytoscape initialized with', data.nodes.length, 'nodes and', validEdges.length, 'valid edges');
        return true;
    } catch (e) {
        console.error('Error initializing Cytoscape:', e);
        document.getElementById('graph-container').innerHTML = `
            <div class="flex flex-col items-center justify-center h-full bg-white p-6 rounded-lg shadow">
                <div class="text-2xl text-red-600 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Error de visualización</div>
                <div class="text-center max-w-lg">
                    No se pudo inicializar la visualización del grafo: ${e.message}
                </div>
                <div class="mt-4">
                    <button class="btn-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt mr-2"></i>Reintentar
                    </button>
                </div>
            </div>
        `;
        return false;
    }
    // Add data change event listener
    cy.on('add remove', 'node, edge', function() {
        // Update statistics if panel is active
        if (document.getElementById('stats-panel').classList.contains('active')) {
            generateStatistics();
        }
    });
}

function handleCytoscapeError(error) {
    const graphContainer = document.getElementById('graph-container');
    graphContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full bg-white p-6 rounded-lg shadow">
            <div class="text-2xl text-red-600 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Error de visualización</div>
            <div class="text-center max-w-lg">
                No se pudo inicializar la visualización del grafo. Error: ${error.message}
                <br><br>
                Verifique que los archivos de datos tienen el formato correcto y que las extensiones de Cytoscape están disponibles.
            </div>
            <div class="mt-4">
                <button class="btn-primary" onclick="location.reload()">
                    <i class="fas fa-sync-alt mr-2"></i>Reintentar
                </button>
            </div>
        </div>
    `;
}
        
        // Initialize controls for graph manipulation
        function initializeControls() {
            // Reset view button
            document.getElementById('reset-view').addEventListener('click', function() {
                cy.fit();
                cy.center();
            });
            
            // Fit all button
            document.getElementById('fit-all').addEventListener('click', function() {
                cy.fit();
            });
            
            // Toggle labels button
            let labelsVisible = true;
            document.getElementById('toggle-labels').addEventListener('click', function() {
                labelsVisible = !labelsVisible;
                
                if (labelsVisible) {
                    cy.style()
                        .selector('node')
                        .style({
                            'label': 'data(label)'
                        })
                        .update();
                    
                    this.innerHTML = '<i class="fas fa-tags"></i> Ocultar etiquetas';
                } else {
                    cy.style()
                        .selector('node')
                        .style({
                            'label': ''
                        })
                        .update();
                    
                    this.innerHTML = '<i class="fas fa-tags"></i> Mostrar etiquetas';
                }
            });
            
            // Layout selector
            document.getElementById('layout-select').addEventListener('change', function() {
                const layout = this.value;
                applyLayout(layout);
            });
            
            // Create path button is handled separately
            
            // Add enhanced controls
            enhanceControls();
        }

        function enhanceControls() {
            const controlsOverlay = document.querySelector('.controls-overlay');
            const enhancedControls = document.createElement('div');
            enhancedControls.className = 'mt-2';
            enhancedControls.innerHTML = `
                <button class="control-button" id="filter-largest-component">
                    <i class="fas fa-filter"></i> Mostrar componente principal
                </button>
                <button class="control-button" id="highlight-courses">
                    <i class="fas fa-graduation-cap"></i> Resaltar cursos
                </button>
                <button class="control-button" id="optimize-view">
                    <i class="fas fa-magic"></i> Optimizar visualización
                </button>
            `;
            
            controlsOverlay.appendChild(enhancedControls);
            
            // Add event listeners
            document.getElementById('filter-largest-component').addEventListener('click', showLargestComponent);
            document.getElementById('highlight-courses').addEventListener('click', highlightCourses);
            document.getElementById('optimize-view').addEventListener('click', optimizeGraphView);
        }

        // Function to show only the largest connected component
        // Function to show only the largest connected component
        function showLargestComponent() {
            // Reset current state
            cy.elements().removeClass('hidden');
            
            // Determine connected components
            const components = cy.elements().components();
            
            // Find the largest component
            let largestComponent = components[0];
            components.forEach(component => {
                if (component.size() > largestComponent.size()) {
                    largestComponent = component;
                }
            });
            
            // Hide all nodes first
            cy.elements().addClass('hidden');
            
            // Show only the largest component
            largestComponent.removeClass('hidden');
            
            // Fit view to visible elements
            cy.fit(largestComponent, 50);
            
            // Notify user
            showNotification(
                'Visualización filtrada',
                `Mostrando el componente principal con ${largestComponent.nodes().length} nodos y ${largestComponent.edges().length} conexiones.`,
                'info'
            );
        }

        // Function to highlight courses
        function highlightCourses() {
            // Reset styles
            cy.elements().removeClass('highlighted faded');
            
            // Highlight course nodes
            const courseNodes = cy.nodes('[type = "course"]');
            courseNodes.addClass('highlighted');
            
            // Fade other nodes
            cy.nodes().difference(courseNodes).addClass('faded');
            
            // Fit to highlighted nodes
            cy.fit(courseNodes, 50);
            
            // Notify user
            showNotification(
                'Cursos resaltados',
                `Se han resaltado ${courseNodes.length} cursos en la visualización.`,
                'info'
            );
        }


        // Function to apply layout with optimized parameters - PLACE THIS IN GLOBAL SCOPE
        function applyLayout(layoutName) {
            // Mostrar indicador de carga
            const loadingSpinner = document.getElementById('loading-spinner');
            if (loadingSpinner) loadingSpinner.classList.add('active');
            
            // Configuraciones específicas para cada tipo de layout
            let layoutOptions = {};
            
            switch(layoutName) {
                case 'cose':
                    layoutOptions = {
                        name: 'cose',
                        nodeDimensionsIncludeLabels: true,
                        padding: 50,
                        animate: true, 
                        animationDuration: 800,
                        randomize: false,
                        componentSpacing: 100,
                        nodeRepulsion: 4500,
                        idealEdgeLength: 100,
                        edgeElasticity: 100,
                        nestingFactor: 1.2,
                        gravity: 80,
                        numIter: 1000,
                        initialTemp: 200,
                        coolingFactor: 0.95,
                        minTemp: 1.0,
                        fit: true
                    };
                    break;
                case 'dagre':
                    layoutOptions = {
                        name: 'dagre',
                        nodeDimensionsIncludeLabels: true,
                        padding: 50,
                        animate: true,
                        animationDuration: 800,
                        rankDir: 'TB',
                        rankSep: 100,
                        edgeSep: 10,
                        nodeSep: 50,
                        fit: true
                    };
                    break;
                case 'breadthfirst':
                    layoutOptions = {
                        name: 'breadthfirst',
                        directed: true,
                        padding: 50,
                        animate: true,
                        animationDuration: 800,
                        spacingFactor: 1.5,
                        fit: true
                    };
                    break;
                case 'concentric':
                    layoutOptions = {
                        name: 'concentric',
                        padding: 50,
                        animate: true,
                        animationDuration: 800,
                        minNodeSpacing: 50,
                        concentric: function(node) {
                            if (node.data('type') === 'course') return 4;
                            if (node.data('type') === 'competency') return 3;
                            if (node.data('type') === 'concept') return 2;
                            return 1;
                        },
                        levelWidth: function() { return 1; },
                        fit: true
                    };
                    break;
                case 'grid':
                    layoutOptions = {
                        name: 'grid',
                        padding: 50,
                        animate: true,
                        animationDuration: 800,
                        avoidOverlap: true,
                        nodeDimensionsIncludeLabels: true,
                        fit: true
                    };
                    break;
                case 'circle':
                    layoutOptions = {
                        name: 'circle',
                        padding: 50,
                        animate: true,
                        animationDuration: 800,
                        radius: 500,
                        fit: true
                    };
                    break;
                case 'cose-bilkent':
                    layoutOptions = {
                        name: 'cose-bilkent',
                        nodeDimensionsIncludeLabels: true,
                        fit: true,
                        padding: 50,
                        animate: true,
                        animationDuration: 800,
                        randomize: false,
                        componentSpacing: 40,
                        nodeRepulsion: 5000,
                        idealEdgeLength: 75,
                        edgeElasticity: 0.45,
                        nestingFactor: 0.1,
                        gravity: 0.25,
                        fit: true
                    };
                    break;
                case 'cola':
                    layoutOptions = {
                        name: 'cola',
                        animate: true,
                        animationDuration: 800,
                        nodeDimensionsIncludeLabels: true,
                        fit: true,
                        padding: 50,
                        maxSimulationTime: 4000,
                        randomize: false,
                        avoidOverlap: true
                    };
                    break;
                default:
                    layoutOptions = {
                        name: 'cose',
                        fit: true,
                        padding: 50
                    };
            }
            
            // Verificar disponibilidad de Cytoscape y número de nodos
            if (!window.cy) {
                console.error('Cytoscape instance not available');
                if (loadingSpinner) loadingSpinner.classList.remove('active');
                showNotification(
                    'Error de diseño',
                    'No se pudo aplicar el diseño: instancia Cytoscape no disponible',
                    'error'
                );
                return;
            }
            
            // Para grafos grandes, optimizar la animación
            const nodeCount = cy.nodes().length;
            if (nodeCount > 500) {
                layoutOptions.animate = false; // Desactivar animación para grafos muy grandes
                showNotification(
                    'Optimización aplicada',
                    'Grafo grande detectado: la animación ha sido desactivada para mejorar el rendimiento',
                    'info'
                );
            }
            
            try {
                // Guardar estado actual de la visualización (zoom y pan)
                const currentPan = cy.pan();
                const currentZoom = cy.zoom();
                
                // Registrar centro aproximado actual
                const centerNode = cy.nodes().length > 0 ? 
                    cy.nodes()[Math.floor(cy.nodes().length / 2)] : null;
                
                // Crear y ejecutar el layout
                const layout = cy.layout(layoutOptions);
                
                // Manejador para cuando el layout se haya completado
                const onLayoutComplete = function() {
                    try {
                        // Asegurar que todos los nodos sean visibles
                        cy.fit(undefined, 50);
                        cy.center();
                        
                        // Actualizar la minimap/navegador si existe
                        if (cy.navigator) {
                            cy.navigator().resize();
                        }
                        
                        // Ocultar spinner de carga
                        if (loadingSpinner) loadingSpinner.classList.remove('active');
                        
                        // Notificar al usuario
                        showNotification(
                            'Diseño aplicado',
                            `Se ha aplicado el diseño ${layoutName} correctamente`,
                            'success'
                        );
                    } catch (innerError) {
                        console.error('Error in layout completion handler:', innerError);
                        if (loadingSpinner) loadingSpinner.classList.remove('active');
                    }
                };
                
                // Configurar evento para cuando termina el layout
                layout.one('layoutstop', onLayoutComplete);
                
                // Ejecutar el layout
                layout.run();
                
                // Para layouts sin animación o si la animación falla
                if (!layoutOptions.animate) {
                    onLayoutComplete();
                } else {
                    // Establecer un timeout como respaldo
                    setTimeout(function() {
                        // Verificar si el loading spinner aún está activo (indicaría que el evento layoutstop no se disparó)
                        if (loadingSpinner && loadingSpinner.classList.contains('active')) {
                            console.warn('Layout timeout reached; forcing completion handler');
                            onLayoutComplete();
                        }
                    }, layoutOptions.animationDuration + 500);
                }
            } catch (e) {
                console.error('Error applying layout:', e);
                
                // Ocultar spinner de carga
                if (loadingSpinner) loadingSpinner.classList.remove('active');
                
                // Intentar centrar y ajustar de todos modos
                try {
                    cy.fit(undefined, 50);
                    cy.center();
                } catch (fitError) {
                    console.error('Error during fallback fit/center:', fitError);
                }
                
                // Mostrar notificación de error
                showNotification(
                    'Error de diseño',
                    'No se pudo aplicar el diseño seleccionado. Se han realizado ajustes automáticos.',
                    'error'
                );
            }
        }

        // Function to optimize graph view
        function optimizeGraphView() {
            // Set a better layout for visualization
            document.getElementById('layout-select').value = 'cose-bilkent';
            applyLayout('cose-bilkent');
            
            // Adjust visual settings
            cy.style()
                .selector('node')
                .style({
                    'font-size': '8px',
                    'width': function(ele) {
                        // Make course nodes larger
                        return ele.data('type') === 'course' ? '35px' : '20px';
                    },
                    'height': function(ele) {
                        return ele.data('type') === 'course' ? '35px' : '20px';
                    }
                })
                .update();
                
            // Show notification
            showNotification(
                'Visualización optimizada',
                'Se ha aplicado un diseño optimizado para mejorar la visualización del grafo.',
                'success'
            );
        }
        
        // Highlight a node and its connections
        function highlightNode(node) {
            // Reset previous highlighting
            cy.elements().removeClass('highlighted faded');
            
            // Highlight the selected node
            node.addClass('highlighted');
            
            // Get connected elements
            const neighborhood = node.neighborhood();
            neighborhood.addClass('highlighted');
            
            // Fade everything else
            cy.elements().difference(neighborhood.union(node)).addClass('faded');
        }
        
        // Show tooltip on node hover
        function showTooltip(node) {
            const tooltip = document.getElementById('graph-tooltip');
            const nodeData = node.data();
            
            // Set tooltip content
            tooltip.innerHTML = `
                <div class="font-semibold mb-1">${nodeData.name}</div>
                <div class="text-xs">${getNodeTypeLabel(nodeData.type)}</div>
                <div class="text-xs mt-1">Haga clic para ver detalles</div>
            `;
            
            // Position tooltip at mouse position
            document.onmousemove = function(e) {
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY + 10) + 'px';
            };
            
            // Show tooltip
            tooltip.style.display = 'block';
        }
        
        // Hide tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('graph-tooltip');
            tooltip.style.display = 'none';
            document.onmousemove = null;
        }
        
        // Get a readable label for node type
        function getNodeTypeLabel(type) {
            switch(type) {
                case 'course': return 'Curso';
                case 'competency': return 'Competencia';
                case 'concept': return 'Concepto';
                case 'normative': return 'Normativa';
                default: return type;
            }
        }
        
        // Show node detail in panel
        function showNodeDetail(node) {
            const nodeData = node.data();
            const originalData = nodeData.nodeData;
            
            // Set panel title
            document.getElementById('detail-title').textContent = nodeData.name;
            
            // Set panel content based on node type
            let infoContent = '';
            let relationsContent = '';
            let analysisContent = '';
            
            switch(nodeData.type) {
                case 'course':
                    infoContent = createCourseDetailContent(originalData);
                    relationsContent = createCourseRelationsContent(node);
                    analysisContent = createCourseAnalysisContent(originalData);

                    
                    break;
                case 'competency':
                    infoContent = createCompetencyDetailContent(originalData);
                    relationsContent = createCompetencyRelationsContent(node);
                    analysisContent = createCompetencyAnalysisContent(originalData);
                    break;
                case 'concept':
                    infoContent = createConceptDetailContent(originalData);
                    relationsContent = createConceptRelationsContent(node);
                    analysisContent = createConceptAnalysisContent(originalData);
                    break;
                case 'normative':
                    infoContent = createNormativeDetailContent(originalData);
                    relationsContent = createNormativeRelationsContent(node);
                    analysisContent = createNormativeAnalysisContent(originalData);
                    break;
            }
            
            // Set panel content
            document.getElementById('info-panel').innerHTML = infoContent;
            document.getElementById('relations-panel').innerHTML = relationsContent;
            document.getElementById('analysis-panel').innerHTML = analysisContent;
            
            // Show panel
            document.getElementById('detail-panel').classList.add('active');
            
            // Initialize accordions
            // Añadir datos JSON con resaltado de sintaxis
            const jsonContent = document.getElementById('json-content');
            if (jsonContent) {
                // Formatea el JSON y aplica el resaltado de sintaxis
                const jsonString = JSON.stringify(nodeData.nodeData, null, 2);
                jsonContent.textContent = jsonString;
                // Aplica highlight.js si está disponible
                if (typeof hljs !== 'undefined') {
                    jsonContent.innerHTML = hljs.highlight(jsonString, {language: 'json'}).value;
                }
            }
            initializeAccordions();
        }
        
        // Create course detail content
        function createCourseDetailContent(course) {
            return `
                <div class="detail-section">
                    <div class="detail-title">Información Básica</div>
                    <div class="mb-2"><strong>Código:</strong> ${course.codigo || 'No disponible'}</div>
                    <div class="mb-2"><strong>Eje Formativo:</strong> ${course.eje_formativo || 'No disponible'}</div>
                    <div class="mb-2"><strong>Área:</strong> ${course.area_organizativa_pfjya || 'No disponible'}</div>
                    <div class="mb-2"><strong>Tipo:</strong> ${course.tipo_formacion || 'No disponible'}</div>
                    <div class="mb-2"><strong>Nivel:</strong> ${course.nivel_dificultad || 'No disponible'}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Objetivo</div>
                    <div>${course.objetivo || 'No disponible'}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Modalidad</div>
                    <div class="mb-2"><strong>General:</strong> ${course.modalidad_general || 'No disponible'}</div>
                    ${course.modalidad_detalle ? `
                        <div class="mb-2"><strong>Detalle:</strong></div>
                        <ul class="list-disc ml-5">
                            ${Array.isArray(course.modalidad_detalle) ? course.modalidad_detalle.map(md => `
                                <li><strong>${md.tipo || 'No especificado'}</strong>${md.plataforma ? ` - ${md.plataforma}` : ''}${md.comentario ? `<br>${md.comentario}` : ''}</li>
                            `).join('') : '<li>No hay detalles disponibles</li>'}
                        </ul>
                    ` : ''}
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Duración y Programación</div>
                    <div class="mb-2"><strong>Duración:</strong> ${course.horario && course.horario.duracion_total_horas ? course.horario.duracion_total_horas + ' horas' : 'No disponible'}</div>
                    <div class="mb-2"><strong>Bimestre:</strong> ${course.bimestre_o_rango_bimestre || 'No disponible'}</div>
                    ${course.horario && course.horario.descripcion ? `<div class="mb-2"><strong>Descripción:</strong> ${course.horario.descripcion}</div>` : ''}
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Evaluación</div>
                    ${course.instrumentos_evaluacion ? `
                        <div class="mb-2"><strong>Instrumentos:</strong></div>
                        <ul class="list-disc ml-5">
                            ${Array.isArray(course.instrumentos_evaluacion) ? course.instrumentos_evaluacion.map(ie => `<li>${ie}</li>`).join('') : '<li>No hay instrumentos disponibles</li>'}
                        </ul>
                    ` : 'No disponible'}
                    
                    ${course.indicadores_medicion ? `
                        <div class="mt-2 mb-2"><strong>Indicadores:</strong></div>
                        <ul class="list-disc ml-5">
                            ${Array.isArray(course.indicadores_medicion) ? course.indicadores_medicion.map(im => `<li>${im}</li>`).join('') : '<li>No hay indicadores disponibles</li>'}
                        </ul>
                    ` : ''}
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Requisitos y Población</div>
                    ${course.requisitos_previos ? `
                        <div class="mb-2"><strong>Requisitos Previos:</strong></div>
                        <ul class="list-disc ml-5">
                            ${Array.isArray(course.requisitos_previos) ? course.requisitos_previos.map(rp => `<li>${rp}</li>`).join('') : '<li>No hay requisitos disponibles</li>'}
                        </ul>
                    ` : 'Sin requisitos específicos'}
                </div>
            `;
        }
        
        // Create competency detail content
        function createCompetencyDetailContent(competency) {
            return `
                <div class="detail-section">
                    <div class="detail-title">Información Básica</div>
                    <div class="mb-2"><strong>Código:</strong> ${competency.courseId ? competency.courseId + '-Cx' : 'No disponible'}</div>
                    <div class="mb-2"><strong>Curso Asociado:</strong> ${competency.courseId || 'No disponible'}</div>
                    <div class="mb-2"><strong>Nivel:</strong> ${competency.nivel || 'No especificado'}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Descripción de la Competencia</div>
                    <div>${competency.competencia || 'No disponible'}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Áreas Jurídicas Asociadas</div>
                    ${competency.areas_asociadas && competency.areas_asociadas.length > 0 ? `
                        <div class="tag-wrapper">
                            ${competency.areas_asociadas.map(area => `<span class="tag">${area}</span>`).join('')}
                        </div>
                    ` : 'No hay áreas asociadas disponibles'}
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Análisis de la Competencia</div>
                    <div class="mb-2">
                        <strong>Tipo de Competencia:</strong> 
                        ${determineCompetencyType(competency.competencia)}
                    </div>
                    <div class="mb-2">
                        <strong>Nivel Taxonómico (Bloom):</strong> 
                        ${determineBloomLevel(competency.competencia)}
                    </div>
                </div>
            `;
        }
        
        // Create concept detail content
        function createConceptDetailContent(concept) {
            return `
                <div class="detail-section">
                    <div class="detail-title">Información Básica</div>
                    <div class="mb-2"><strong>ID:</strong> ${concept.ID_Nodo_Conceptual || 'No disponible'}</div>
                    <div class="mb-2"><strong>Nivel de Complejidad:</strong> ${concept.nivel_complejidad_conceptual || 'No especificado'}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Concepto Principal</div>
                    <div class="mb-2">${concept.concepto_principal || 'No disponible'}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Descripción Conceptual</div>
                    <div>${concept.descripcion_conceptual || 'No disponible'}</div>
                </div>
                
                ${concept.referencias_legales ? `
                    <div class="detail-section">
                        <div class="detail-title">Referencias Legales</div>
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Ver Referencias (${Array.isArray(concept.referencias_legales) ? concept.referencias_legales.length : 0})</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                ${Array.isArray(concept.referencias_legales) ? concept.referencias_legales.map(ref => `
                                    <div class="mb-3">
                                        <div class="font-semibold">${ref.fuente}${ref.articulo && ref.articulo !== 'N/A' ? ` - Art. ${ref.articulo}` : ''}</div>
                                        <div class="text-sm">${ref.descripcion || 'No hay descripción disponible'}</div>
                                    </div>
                                `).join('') : 'No hay referencias disponibles'}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${concept.aplicaciones_practicas ? `
                    <div class="detail-section">
                        <div class="detail-title">Aplicaciones Prácticas</div>
                        <ul class="list-disc ml-5">
                            ${Array.isArray(concept.aplicaciones_practicas) ? concept.aplicaciones_practicas.map(ap => `<li>${ap}</li>`).join('') : '<li>No hay aplicaciones disponibles</li>'}
                        </ul>
                    </div>
                ` : ''}
                
                ${concept.implicaciones_formativas ? `
                    <div class="detail-section">
                        <div class="detail-title">Implicaciones Formativas</div>
                        <ul class="list-disc ml-5">
                            ${Array.isArray(concept.implicaciones_formativas) ? concept.implicaciones_formativas.map(imp => `<li>${imp}</li>`).join('') : '<li>No hay implicaciones disponibles</li>'}
                        </ul>
                    </div>
                ` : ''}
            `;
        }
        
        // Create normative detail content
        function createNormativeDetailContent(normative) {
            return `
                <div class="detail-section">
                    <div class="detail-title">Información Normativa</div>
                    <div class="mb-2"><strong>Fuente:</strong> ${normative.fuente || 'No disponible'}</div>
                    ${normative.articulo && normative.articulo !== 'N/A' ? `
                        <div class="mb-2"><strong>Artículo:</strong> ${normative.articulo}</div>
                    ` : ''}
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Descripción</div>
                    <div>${normative.descripcion || 'No disponible'}</div>
                </div>
            `;
        }
        
        // Create course relations content
        function createCourseRelationsContent(node) {
            // Get connected nodes
            const connectedCompetencies = node.outgoers('node[type = "competency"]');
            const connectedConcepts = node.neighborhood('node[type = "concept"]');
            
            return `
                <div class="p-4">
                    <h3 class="font-bold mb-3 text-primary">Competencias Desarrolladas (${connectedCompetencies.length})</h3>
                    ${connectedCompetencies.length > 0 ? `
                        <ul class="list-disc ml-5 mb-4">
                            ${connectedCompetencies.map(comp => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${comp.id()}">${comp.data('name')}</a>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500 mb-4">No hay competencias directamente asociadas</p>'}
                    
                    <h3 class="font-bold mb-3 text-primary">Conceptos Relacionados (${connectedConcepts.length})</h3>
                    ${connectedConcepts.length > 0 ? `
                        <ul class="list-disc ml-5">
                            ${connectedConcepts.map(concept => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${concept.id()}">${concept.data('name')}</a>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500">No hay conceptos directamente relacionados</p>'}
                </div>
            `;
        }
        
        // Create competency relations content
        function createCompetencyRelationsContent(node) {
            // Get connected nodes
            const coursesIn = node.incomers('node[type = "course"]');
            const conceptsIn = node.incomers('node[type = "concept"]');
            const conceptsOut = node.outgoers('node[type = "concept"]');
            
            return `
                <div class="p-4">
                    <h3 class="font-bold mb-3 text-primary">Cursos Relacionados (${coursesIn.length})</h3>
                    ${coursesIn.length > 0 ? `
                        <ul class="list-disc ml-5 mb-4">
                            ${coursesIn.map(course => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${course.id()}">${course.data('name')}</a>
                                    <span class="text-sm text-gray-500"> - desarrolla esta competencia</span>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500 mb-4">No hay cursos directamente asociados</p>'}
                    
                    <h3 class="font-bold mb-3 text-primary">Conceptos que Apoyan (${conceptsIn.length})</h3>
                    ${conceptsIn.length > 0 ? `
                        <ul class="list-disc ml-5 mb-4">
                            ${conceptsIn.map(concept => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${concept.id()}">${concept.data('name')}</a>
                                    <span class="text-sm text-gray-500"> - apoya esta competencia</span>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500 mb-4">No hay conceptos que apoyen directamente</p>'}
                    
                    <h3 class="font-bold mb-3 text-primary">Conceptos Apoyados (${conceptsOut.length})</h3>
                    ${conceptsOut.length > 0 ? `
                        <ul class="list-disc ml-5">
                            ${conceptsOut.map(concept => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${concept.id()}">${concept.data('name')}</a>
                                    <span class="text-sm text-gray-500"> - apoyado por esta competencia</span>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500">No hay conceptos apoyados directamente</p>'}
                </div>
            `;
        }
        
        // Create concept relations content
        function createConceptRelationsContent(node) {
            // Get connected nodes
            const competencies = node.neighborhood('node[type = "competency"]');
            const courses = node.neighborhood('node[type = "course"]');
            const normative = node.outgoers('node[type = "normative"]');
            const relatedConcepts = node.neighborhood('node[type = "concept"]');
            
            // Remove self from related concepts
            const otherConcepts = relatedConcepts.filter(n => n.id() !== node.id());
            
            return `
                <div class="p-4">
                    <h3 class="font-bold mb-3 text-primary">Competencias Relacionadas (${competencies.length})</h3>
                    ${competencies.length > 0 ? `
                        <ul class="list-disc ml-5 mb-4">
                            ${competencies.map(comp => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${comp.id()}">${comp.data('name')}</a>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500 mb-4">No hay competencias directamente relacionadas</p>'}
                    
                    <h3 class="font-bold mb-3 text-primary">Cursos Relacionados (${courses.length})</h3>
                    ${courses.length > 0 ? `
                        <ul class="list-disc ml-5 mb-4">
                            ${courses.map(course => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${course.id()}">${course.data('name')}</a>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500 mb-4">No hay cursos directamente relacionados</p>'}
                    
                    <h3 class="font-bold mb-3 text-primary">Normativa Relacionada (${normative.length})</h3>
                    ${normative.length > 0 ? `
                        <ul class="list-disc ml-5 mb-4">
                            ${normative.map(norm => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${norm.id()}">${norm.data('name')}</a>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500 mb-4">No hay normativa directamente relacionada</p>'}
                    
                    <h3 class="font-bold mb-3 text-primary">Otros Conceptos Relacionados (${otherConcepts.length})</h3>
                    ${otherConcepts.length > 0 ? `
                        <ul class="list-disc ml-5">
                            ${otherConcepts.map(concept => {
                                // Get edge between this concept and the other concept
                                const edge = node.edgesWith(concept);
                                let relationText = '';
                                
                                if (edge.length > 0) {
                                    const edgeData = edge[0].data();
                                    if (edgeData.source === node.id()) {
                                        relationText = ` - ${formatRelationType(edgeData.label)}`;
                                    } else {
                                        relationText = ` - ${formatRelationTypeReverse(edgeData.label)}`;
                                    }
                                }
                                
                                return `
                                    <li class="mb-1">
                                        <a href="#" class="text-primary hover:underline" data-node-id="${concept.id()}">${concept.data('name')}</a>
                                        <span class="text-sm text-gray-500">${relationText}</span>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500">No hay otros conceptos directamente relacionados</p>'}
                </div>
            `;
        }
        
        // Create normative relations content
        function createNormativeRelationsContent(node) {
            // Get connected concepts
            const concepts = node.incomers('node[type = "concept"]');
            
            return `
                <div class="p-4">
                    <h3 class="font-bold mb-3 text-primary">Conceptos Regulados (${concepts.length})</h3>
                    ${concepts.length > 0 ? `
                        <ul class="list-disc ml-5">
                            ${concepts.map(concept => `
                                <li class="mb-1">
                                    <a href="#" class="text-primary hover:underline" data-node-id="${concept.id()}">${concept.data('name')}</a>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="italic text-gray-500">No hay conceptos directamente regulados</p>'}
                </div>
            `;
        }
        
        // Format relation type for display
        function formatRelationType(type) {
            switch(type) {
                case 'desarrolla': return 'desarrolla';
                case 'apoya': return 'apoya';
                case 'incluye': return 'incluye';
                case 'reguladoPor': return 'regulado por';
                case 'esSubtipoDe': return 'es subtipo de';
                case 'seRelacionaCon': return 'se relaciona con';
                case 'implicaConcepto': return 'implica';
                case 'seDiferenciaDe': return 'se diferencia de';
                case 'seVinculaCon': return 'se vincula con';
                case 'esAplicacionDe': return 'es aplicación de';
                case 'requiereHabilidad': return 'requiere habilidad';
                case 'tieneComponente': return 'tiene componente';
                default: return type;
            }
        }
        
        // Format relation type in reverse direction
        function formatRelationTypeReverse(type) {
            switch(type) {
                case 'desarrolla': return 'desarrollado por';
                case 'apoya': return 'apoyado por';
                case 'incluye': return 'incluido en';
                case 'reguladoPor': return 'regula';
                case 'esSubtipoDe': return 'es supertipo de';
                case 'seRelacionaCon': return 'se relaciona con';
                case 'implicaConcepto': return 'implicado por';
                case 'seDiferenciaDe': return 'se diferencia de';
                case 'seVinculaCon': return 'se vincula con';
                case 'esAplicacionDe': return 'aplicado en';
                case 'requiereHabilidad': return 'habilidad requerida para';
                case 'tieneComponente': return 'es componente de';
                default: return 'relacionado con';
            }
        }
        
        // Create course analysis content
        function createCourseAnalysisContent(course) {
            return `
                <div class="p-4">
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-primary">Análisis de Relevancia</h3>
                        <div class="mb-2">
                            <strong>Impacto en Profesionalización:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Relevancia para el desarrollo profesional.</div>
                        </div>
                        <div class="mb-2">
                            <strong>Alineación Estratégica:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Alineación con objetivos institucionales.</div>
                        </div>
                        <div>
                            <strong>Cobertura de Competencias:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-amber-500 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Cobertura de competencias clave.</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2 text-primary">Recomendaciones</h3>
                        <ul class="list-disc ml-5 space-y-1">
                            <li class="mb-1">Fortalecer la conexión con otros cursos relacionados.</li>
                            <li class="mb-1">Considerar desarrollo de material complementario en áreas específicas.</li>
                            <li class="mb-1">Evaluar la posibilidad de ampliar duración para profundizar contenidos.</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Create competency analysis content
        function createCompetencyAnalysisContent(competency) {
            return `
                <div class="p-4">
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-primary">Análisis de la Competencia</h3>
                        <div class="mb-3">
                            <strong>Nivel Taxonómico (Bloom):</strong> ${determineBloomLevel(competency.competencia)}
                        </div>
                        <div class="mb-3">
                            <strong>Tipo de Competencia:</strong> ${determineCompetencyType(competency.competencia)}
                        </div>
                        <div>
                            <strong>Cobertura en Cursos:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Nivel de cobertura en el plan formativo.</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2 text-primary">Recomendaciones</h3>
                        <ul class="list-disc ml-5 space-y-1">
                            <li class="mb-1">Integrar esta competencia en más actividades formativas.</li>
                            <li class="mb-1">Desarrollar evaluaciones específicas que midan su adquisición.</li>
                            <li class="mb-1">Considerar su inclusión en rutas formativas específicas.</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Create concept analysis content
        function createConceptAnalysisContent(concept) {
            return `
                <div class="p-4">
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-primary">Análisis del Concepto</h3>
                        <div class="mb-2">
                            <strong>Centralidad en el Ecosistema:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Conectividad en el ecosistema de conocimiento.</div>
                        </div>
                        <div class="mb-2">
                            <strong>Relevancia Normativa:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Relevancia en el marco normativo aplicable.</div>
                        </div>
                        <div>
                            <strong>Aplicabilidad Práctica:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Aplicabilidad en la práctica judicial.</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2 text-primary">Evolución del Concepto</h3>
                        <p class="mb-2">Este concepto ha mantenido su relevancia en el sistema judicial, con particular importancia en los últimos años debido a reformas procesales.</p>
                        <p>Se sugiere fortalecer su conexión con conceptos emergentes relacionados y actualizar referencias jurisprudenciales.</p>
                    </div>
                </div>
            `;
        }
        
        // Create normative analysis content
        function createNormativeAnalysisContent(normative) {
            return `
                <div class="p-4">
                    <div class="mb-4">
                        <h3 class="font-bold mb-2 text-primary">Análisis de Impacto Normativo</h3>
                        <div class="mb-2">
                            <strong>Relevancia en Formación Judicial:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-pink-500 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Relevancia para la formación judicial.</div>
                        </div>
                        <div>
                            <strong>Frecuencia de Aplicación:</strong>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${getRandomScore()}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Aplicación en la práctica judicial cotidiana.</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2 text-primary">Recomendaciones</h3>
                        <ul class="list-disc ml-5 space-y-1">
                            <li class="mb-1">Fortalecer la conexión con jurisprudencia reciente.</li>
                            <li class="mb-1">Desarrollar casos prácticos específicos para esta normativa.</li>
                            <li class="mb-1">Considerar actualización según reformas recientes.</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Determine Bloom's taxonomy level
        function determineBloomLevel(text) {
            if (!text) return '<span class="badge badge-secondary">No determinado</span>';
            
            text = text.toLowerCase();
            
            // Check for verbs that indicate different levels
            if (text.includes('crear') || text.includes('diseñar') || text.includes('producir') || text.includes('generar')) {
                return '<span class="badge badge-success">Creación</span> (Nivel 6)';
            } else if (text.includes('evaluar') || text.includes('valorar') || text.includes('justificar') || text.includes('criticar')) {
                return '<span class="badge badge-info">Evaluación</span> (Nivel 5)';
            } else if (text.includes('analizar') || text.includes('diferenciar') || text.includes('organizar') || text.includes('comparar')) {
                return '<span class="badge badge-primary">Análisis</span> (Nivel 4)';
            } else if (text.includes('aplicar') || text.includes('desarrollar') || text.includes('implementar') || text.includes('utilizar')) {
                return '<span class="badge badge-primary">Aplicación</span> (Nivel 3)';
            } else if (text.includes('comprender') || text.includes('explicar') || text.includes('interpretar') || text.includes('describir')) {
                return '<span class="badge badge-secondary">Comprensión</span> (Nivel 2)';
            } else if (text.includes('reconocer') || text.includes('recordar') || text.includes('identificar') || text.includes('listar')) {
                return '<span class="badge badge-secondary">Conocimiento</span> (Nivel 1)';
            } else {
                return '<span class="badge badge-secondary">No determinado</span>';
            }
        }
        
        // Determine competency type
        function determineCompetencyType(text) {
            if (!text) return '<span class="badge badge-secondary">General</span>';
            
            text = text.toLowerCase();
            
            if (text.includes('ética') || text.includes('valores') || text.includes('integridad') || text.includes('responsabilidad')) {
                return '<span class="badge badge-primary">Ética y Valores</span>';
            } else if (text.includes('comunicación') || text.includes('expresión') || text.includes('redacción') || text.includes('exposición')) {
                return '<span class="badge badge-info">Comunicativa</span>';
            } else if (text.includes('análisis') || text.includes('investigación') || text.includes('razonamiento') || text.includes('pensamiento crítico')) {
                return '<span class="badge badge-success">Analítica</span>';
            } else if (text.includes('gestión') || text.includes('dirección') || text.includes('liderazgo') || text.includes('organización')) {
                return '<span class="badge badge-secondary">Gestión y Liderazgo</span>';
            } else if (text.includes('técnica') || text.includes('procesal') || text.includes('jurídica') || text.includes('normativa')) {
                return '<span class="badge badge-info">Técnica-Jurídica</span>';
            } else {
                return '<span class="badge badge-secondary">General</span>';
            }
        }
        
        // Helper function to get random score for demo
        function getRandomScore() {
            return Math.floor(Math.random() * (95 - 60 + 1)) + 60;
        }
        
        // Initialize accordions
        function initializeAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', function() {
                    // Get the next element (content)
                    const content = this.nextElementSibling;
                    
                    // Toggle the active class
                    content.classList.toggle('active');
                    
                    // Toggle the icon
                    const icon = this.querySelector('i');
                    if (content.classList.contains('active')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                });
            });
        }
        
        // Initialize filters
        function initializeFilters(data) {
            // Initialize area filters
            initializeFilterCheckboxes('area-filters', data.areas, 'area-filter');
            
            // Initialize type filters
            initializeFilterCheckboxes('type-filters', data.types, 'type-filter');
            
            // Initialize level filters
            initializeFilterCheckboxes('level-filters', data.levels, 'level-filter');
            
            // Initialize category filters
            initializeFilterCheckboxes('category-filters', data.categories, 'category-filter');
            
            // Initialize complexity filters
            initializeFilterCheckboxes('complexity-filters', data.complexities, 'complexity-filter');
            
            // Add event listeners
            document.querySelectorAll('.area-filter, .type-filter').forEach(filter => {
                filter.addEventListener('change', function() {
                    filterNodes('course');
                });
            });
            
            document.querySelectorAll('.level-filter').forEach(filter => {
                filter.addEventListener('change', function() {
                    filterNodes('competency');
                });
            });
            
            document.querySelectorAll('.category-filter, .complexity-filter').forEach(filter => {
                filter.addEventListener('change', function() {
                    filterNodes('concept');
                });
            });
        }
        
        // Initialize filter checkboxes
        function initializeFilterCheckboxes(containerId, values, className) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear container
            container.innerHTML = '';
            
            // Add 'All' option
            const allOption = document.createElement('div');
            allOption.innerHTML = `
                <label class="flex items-center space-x-2 mb-1 cursor-pointer">
                    <input type="checkbox" value="all" class="${className} all" checked>
                    <span><strong>Todos</strong></span>
                </label>
            `;
            container.appendChild(allOption);
            
            // Add filter for each value
            values.forEach(value => {
                if (!value) return; // Skip empty values
                
                const option = document.createElement('div');
                option.innerHTML = `
                    <label class="flex items-center space-x-2 mb-1 cursor-pointer">
                        <input type="checkbox" value="${value}" class="${className} item" checked>
                        <span>${value}</span>
                    </label>
                `;
                container.appendChild(option);
            });
            
            // Add event listener for 'All' checkbox
            const allCheckbox = container.querySelector(`.${className}.all`);
            allCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                container.querySelectorAll(`.${className}.item`).forEach(item => {
                    item.checked = isChecked;
                });
            });
            
            // Add event listener for item checkboxes
            container.querySelectorAll(`.${className}.item`).forEach(item => {
                item.addEventListener('change', function() {
                    const allItems = container.querySelectorAll(`.${className}.item`);
                    const checkedItems = container.querySelectorAll(`.${className}.item:checked`);
                    
                    // Update 'All' checkbox
                    allCheckbox.checked = checkedItems.length === allItems.length;
                    
                    // If no items are checked, check 'All'
                    if (checkedItems.length === 0) {
                        allCheckbox.checked = true;
                        allItems.forEach(item => {
                            item.checked = true;
                        });
                    }
                });
            });
        }
        
        // Filter nodes based on filters
        function filterNodes(nodeType) {
            // Get selected filters
            const selectedAreas = getSelectedValues('area-filter');
            const selectedTypes = getSelectedValues('type-filter');
            const selectedLevels = getSelectedValues('level-filter');
            const selectedCategories = getSelectedValues('category-filter');
            const selectedComplexities = getSelectedValues('complexity-filter');
            
            // Get the nodes of the specified type
            let nodes = [];
            switch(nodeType) {
                case 'course':
                    // Filter based on area and type
                    nodes = cy.nodes().filter(node => {
                        const data = node.data();
                        if (data.type !== 'course') return false;
                        
                        const nodeData = data.nodeData;
                        const areaMatch = selectedAreas.length === 0 || selectedAreas.includes(nodeData.area_organizativa_pfjya);
                        const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(nodeData.tipo_formacion);
                        
                        return areaMatch && typeMatch;
                    });
                    break;
                    
                case 'competency':
                    // Filter based on level
                    nodes = cy.nodes().filter(node => {
                        const data = node.data();
                        if (data.type !== 'competency') return false;
                        
                        const nodeData = data.nodeData;
                        const levelMatch = selectedLevels.length === 0 || selectedLevels.includes(nodeData.nivel);
                        
                        return levelMatch;
                    });
                    break;
                    
                case 'concept':
                    // Filter based on category and complexity
                    nodes = cy.nodes().filter(node => {
                        const data = node.data();
                        if (data.type !== 'concept') return false;
                        
                        const nodeData = data.nodeData;
                        const complexityMatch = selectedComplexities.length === 0 || selectedComplexities.includes(nodeData.nivel_complejidad_conceptual);
                        
                        // Category matching would require additional data structure
                        // Assume all concepts match the category filter for now
                        const categoryMatch = true;
                        
                        return complexityMatch && categoryMatch;
                    });
                    break;
            }
            
            // Update the list view
            updateNodeList(nodeType, nodes);
            // Update statistics if panel is active
            if (document.getElementById('stats-panel').classList.contains('active')) {
                generateStatistics();
            }
        }
        
        // Get selected values from checkboxes
        function getSelectedValues(className) {
            const checkboxes = document.querySelectorAll(`.${className}.item:checked`);
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }
        
        // Update node list
        function updateNodeList(nodeType, nodes) {
            let listId = '';
            switch(nodeType) {
                case 'course': listId = 'course-list'; break;
                case 'competency': listId = 'competency-list'; break;
                case 'concept': listId = 'concept-list'; break;
            }
            
            const list = document.getElementById(listId);
            if (!list) return;
            
            // Clear list
            list.innerHTML = '';
            
            // Add nodes to list
            nodes.forEach(node => {
                const data = node.data();
                
                const listItem = document.createElement('li');
                listItem.className = 'node-item';
                listItem.setAttribute('data-id', data.id);
                
                switch(nodeType) {
                    case 'course':
                        listItem.innerHTML = `
                            <div class="font-semibold">${data.label}</div>
                            <div class="text-sm truncate">${data.name}</div>
                        `;
                        break;
                        
                    case 'competency':
                        listItem.innerHTML = `
                            <div class="font-semibold">${data.label} (${data.nodeData.courseId})</div>
                            <div class="text-sm truncate">${truncateText(data.name, 60)}</div>
                        `;
                        break;
                        
                    case 'concept':
                        listItem.innerHTML = `
                            <div class="font-semibold">${data.label}</div>
                            <div class="text-sm truncate">${data.name}</div>
                        `;
                        break;
                }
                
                // Add click event
                listItem.addEventListener('click', function() {
                    // Highlight the node in the graph
                    const node = cy.getElementById(data.id);
                    highlightNode(node);
                    showNodeDetail(node);
                    
                    // Update active class in list
                    list.querySelectorAll('.node-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');
                });
                
                list.appendChild(listItem);
            });
            
            // Show message if no nodes
            if (nodes.length === 0) {
                const message = document.createElement('li');
                message.className = 'p-4 text-center text-gray-500 italic';
                message.textContent = 'No se encontraron elementos con los filtros aplicados.';
                list.appendChild(message);
            }
        }
        
        function populateLists(data) {
            try {
                // Check if Cytoscape is initialized
                if (!window.cy) {
                    console.warn('Cytoscape not initialized, using data directly for lists');
                    
                    // Populate course list
                    updateNodeListDirect('course', data.courses);
                    
                    // Populate competency list
                    updateNodeListDirect('competency', data.competencies);
                    
                    // Populate concept list
                    updateNodeListDirect('concept', data.concepts);
                    
                    return;
                }
                
                // If Cytoscape is available, use it
                // Populate course list
                updateNodeList('course', cy.nodes('[type = "course"]'));
                
                // Populate competency list
                updateNodeList('competency', cy.nodes('[type = "competency"]'));
                
                // Populate concept list
                updateNodeList('concept', cy.nodes('[type = "concept"]'));
            } catch (error) {
                console.error('Error populating lists:', error);
            }
        }

        // New function to update lists directly from data
        function updateNodeListDirect(nodeType, nodes) {
            let listId = '';
            switch(nodeType) {
                case 'course': listId = 'course-list'; break;
                case 'competency': listId = 'competency-list'; break;
                case 'concept': listId = 'concept-list'; break;
            }
            
            const list = document.getElementById(listId);
            if (!list) return;
            
            // Clear list
            list.innerHTML = '';
            
            // Add nodes to list
            nodes.forEach(node => {
                const listItem = document.createElement('li');
                listItem.className = 'node-item';
                listItem.setAttribute('data-id', node.id);
                
                switch(nodeType) {
                    case 'course':
                        listItem.innerHTML = `
                            <div class="font-semibold">${node.label}</div>
                            <div class="text-sm truncate">${node.name}</div>
                        `;
                        break;
                        
                    case 'competency':
                        listItem.innerHTML = `
                            <div class="font-semibold">${node.label} (${node.data.courseId || 'N/A'})</div>
                            <div class="text-sm truncate">${truncateText(node.name, 60)}</div>
                        `;
                        break;
                        
                    case 'concept':
                        listItem.innerHTML = `
                            <div class="font-semibold">${node.label}</div>
                            <div class="text-sm truncate">${node.name}</div>
                        `;
                        break;
                }
                
                // Add click event - but with Cytoscape check
                listItem.addEventListener('click', function() {
                    if (window.cy) {
                        // Highlight the node in the graph if Cytoscape is available
                        const cyNode = cy.getElementById(this.getAttribute('data-id'));
                        if (cyNode.length > 0) {
                            highlightNode(cyNode);
                            showNodeDetail(cyNode);
                        }
                    }
                    
                    // Update active class in list
                    list.querySelectorAll('.node-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');
                });
                
                list.appendChild(listItem);
            });
            
            // Show message if no nodes
            if (nodes.length === 0) {
                const message = document.createElement('li');
                message.className = 'p-4 text-center text-gray-500 italic';
                message.textContent = 'No se encontraron elementos con los filtros aplicados.';
                list.appendChild(message);
            }
        }
        
        // Initialize sidebar
        function initializeSidebar() {
            // Sidebar toggle
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggle-icon');
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('sidebar-closed');
                this.classList.toggle('closed');
                
                // Update toggle icon
                if (sidebar.classList.contains('sidebar-closed')) {
                    toggleIcon.classList.remove('fa-chevron-left');
                    toggleIcon.classList.add('fa-chevron-right');
                } else {
                    toggleIcon.classList.remove('fa-chevron-right');
                    toggleIcon.classList.add('fa-chevron-left');
                }
            });
            
            // Close detail panel button
            document.getElementById('close-detail').addEventListener('click', function() {
                document.getElementById('detail-panel').classList.remove('active');
                
                // Reset highlighting
                cy.elements().removeClass('highlighted faded');
            });
            
            // Initialize node list links
            document.addEventListener('click', function(event) {
                // Check if the clicked element is a node link
                if (event.target.hasAttribute('data-node-id')) {
                    event.preventDefault();
                    
                    // Get the node ID
                    const nodeId = event.target.getAttribute('data-node-id');
                    
                    // Find the node in the graph
                    const node = cy.getElementById(nodeId);
                    
                    // If node exists, highlight and show details
                    if (node.length > 0) {
                        highlightNode(node);
                        showNodeDetail(node);
                    }
                }
            });
        }

        // Initialize statistics panel
        function initializeStatsPanel() {
            // Add event listener for show stats button
            document.getElementById('show-stats').addEventListener('click', function() {
                // Show stats panel
                document.getElementById('stats-panel').classList.add('active');
                
                // Generate statistics
                generateStatistics();
            });
            
            // Add event listener for close stats button
            document.getElementById('close-stats').addEventListener('click', function() {
                // Hide stats panel
                document.getElementById('stats-panel').classList.remove('active');
            });
        }

        // Generate statistics for the panel
        function generateStatistics() {
            // Generate general statistics
            generateGeneralStats();
            
            // Generate distribution charts
            generateAreasChart();
            generateEjesChart();
            generateCompetenciesChart();
            generateConceptsChart();
        }

        // Generate general statistics
        function generateGeneralStats() {
            const generalStatsContainer = document.getElementById('general-stats');
            
            // Clear container
            generalStatsContainer.innerHTML = '';
            
            // Get counts
            const courseCount = cy.nodes('[type = "course"]').length;
            const competencyCount = cy.nodes('[type = "competency"]').length;
            const conceptCount = cy.nodes('[type = "concept"]').length;
            const normativeCount = cy.nodes('[type = "normative"]').length;
            const totalNodeCount = cy.nodes().length;
            const totalEdgeCount = cy.edges().length;
            
            // Create stats cards
            const statsData = [
                { value: courseCount, label: 'Cursos', color: '#f59e0b' },
                { value: competencyCount, label: 'Competencias', color: '#3b82f6' },
                { value: conceptCount, label: 'Conceptos', color: '#10b981' },
                { value: normativeCount, label: 'Normativas', color: '#ef4444' },
                { value: totalNodeCount, label: 'Total Nodos', color: '#6366f1' },
                { value: totalEdgeCount, label: 'Conexiones', color: '#8b5cf6' }
            ];
            
            // Add cards to container
            statsData.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stats-card';
                card.innerHTML = `
                    <div class="stats-card-value" style="color: ${stat.color}">${stat.value}</div>
                    <div class="stats-card-label">${stat.label}</div>
                `;
                generalStatsContainer.appendChild(card);
            });
        }

        // Generate areas distribution chart
        function generateAreasChart() {
            // Get area distribution
            const areas = {};
            cy.nodes('[type = "course"]').forEach(node => {
                const area = node.data('nodeData').area_organizativa_pfjya || 'No especificada';
                areas[area] = (areas[area] || 0) + 1;
            });
            
            // Prepare data for chart
            const labels = Object.keys(areas);
            const data = Object.values(areas);
            const backgroundColors = generateColorArray(labels.length, 0.7);
            
            // Create chart
            createOrUpdateChart('areas-chart', 'pie', {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: 'white',
                    borderWidth: 1
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Distribución de Cursos por Área',
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            });
        }

        // Generate ejes formativos distribution chart
        function generateEjesChart() {
            // Get eje formativo distribution
            const ejes = {};
            cy.nodes('[type = "course"]').forEach(node => {
                const eje = node.data('nodeData').eje_formativo || 'No especificado';
                ejes[eje] = (ejes[eje] || 0) + 1;
            });
            
            // Prepare data for chart
            const labels = Object.keys(ejes);
            const data = Object.values(ejes);
            const backgroundColors = generateColorArray(labels.length, 0.7);
            
            // Create chart
            createOrUpdateChart('ejes-chart', 'doughnut', {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: 'white',
                    borderWidth: 1
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Distribución de Cursos por Eje Formativo',
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            });
        }

        // Generate competencies chart
        function generateCompetenciesChart() {
            // Get competency levels
            const levels = {};
            cy.nodes('[type = "competency"]').forEach(node => {
                const level = node.data('nodeData').nivel || 'No especificado';
                levels[level] = (levels[level] || 0) + 1;
            });
            
            // Prepare data for chart
            const labels = Object.keys(levels);
            const data = Object.values(levels);
            
            // Create chart
            createOrUpdateChart('competencies-chart', 'bar', {
                labels: labels,
                datasets: [{
                    label: 'Competencias por Nivel',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Distribución de Competencias por Nivel',
                        font: {
                            size: 14
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            });
        }

        // Generate concepts chart
        function generateConceptsChart() {
            // Get concept complexity
            const complexities = {};
            cy.nodes('[type = "concept"]').forEach(node => {
                const complexity = node.data('nodeData').nivel_complejidad_conceptual || 'No especificado';
                complexities[complexity] = (complexities[complexity] || 0) + 1;
            });
            
            // Prepare data for chart
            const labels = Object.keys(complexities);
            const data = Object.values(complexities);
            const backgroundColors = generateColorArray(labels.length, 0.7);
            
            // Create chart
            createOrUpdateChart('concepts-chart', 'polarArea', {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Distribución de Conceptos por Complejidad',
                        font: {
                            size: 14
                        }
                    }
                }
            });
        }

        // Helper function to create or update a chart
        function createOrUpdateChart(canvasId, type, data, options) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Check if chart already exists
            if (canvas.chart) {
                // Update existing chart
                canvas.chart.data = data;
                canvas.chart.options = options;
                canvas.chart.update();
            } else {
                // Create new chart
                canvas.chart = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: options
                });
            }
        }

        // Helper function to generate an array of colors
        function generateColorArray(count, alpha) {
            const baseColors = [
                `rgba(59, 130, 246, ${alpha})`,   // Blue
                `rgba(16, 185, 129, ${alpha})`,   // Green
                `rgba(245, 158, 11, ${alpha})`,   // Amber
                `rgba(239, 68, 68, ${alpha})`,    // Red
                `rgba(99, 102, 241, ${alpha})`,   // Indigo
                `rgba(139, 92, 246, ${alpha})`,   // Purple
                `rgba(236, 72, 153, ${alpha})`,   // Pink
                `rgba(5, 150, 105, ${alpha})`,    // Emerald
                `rgba(217, 119, 6, ${alpha})`,    // Amber dark
                `rgba(124, 58, 237, ${alpha})`    // Violet
            ];
            
            // If we need more colors than in our base array
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            
            return colors;
        }

        // Generate advanced statistics
        function generateAdvancedStats() {
            // Calculate connection density
            const nodeCount = cy.nodes().length;
            const edgeCount = cy.edges().length;
            const maxPossibleEdges = nodeCount * (nodeCount - 1); // Dirigido
            const density = maxPossibleEdges > 0 ? edgeCount / maxPossibleEdges : 0;
            
            // Calculate average degree
            const degrees = cy.nodes().map(node => node.degree());
            const avgDegree = degrees.reduce((sum, degree) => sum + degree, 0) / nodeCount;
            
            // Calculate connected components
            const components = cy.elements().components();
            const largestComponent = components.reduce((max, component) => 
                component.length > max.length ? component : max, components[0] || []);
            const largestComponentSize = largestComponent ? largestComponent.length : 0;
            const largestComponentPercentage = nodeCount > 0 ? 
                Math.round((largestComponentSize / nodeCount) * 100) : 0;
            
            // Calculate node connectedness by type
            const typeConnectivity = {};
            const nodeTypes = ['course', 'competency', 'concept', 'normative'];
            
            nodeTypes.forEach(type => {
                const typeNodes = cy.nodes(`[type = "${type}"]`);
                if (typeNodes.length > 0) {
                    const typeEdges = typeNodes.connectedEdges();
                    const avgConnections = typeEdges.length / typeNodes.length;
                    typeConnectivity[type] = avgConnections;
                }
            });
            
            return {
                density,
                avgDegree,
                components: components.length,
                largestComponentPercentage,
                typeConnectivity
            };
        }

        // Analyze semantic connections
        function analyzeSemanticConnections() {
            // Count edge types
            const edgeTypes = {};
            cy.edges().forEach(edge => {
                const type = edge.data('label') || 'No especificado';
                edgeTypes[type] = (edgeTypes[type] || 0) + 1;
            });
            
            // Calculate course to competency ratio
            const courseCount = cy.nodes('[type = "course"]').length;
            const competencyCount = cy.nodes('[type = "competency"]').length;
            const courseCompetencyRatio = courseCount > 0 ? competencyCount / courseCount : 0;
            
            // Calculate concept to competency connections
            const conceptToCompetencyCount = cy.edges().filter(edge => 
                edge.source().data('type') === 'concept' && 
                edge.target().data('type') === 'competency'
            ).length;
            
            return {
                edgeTypes,
                courseCompetencyRatio,
                conceptToCompetencyCount
            };
        }
        
        // Initialize search
        function initializeSearch(data) {
            const searchInput = document.getElementById('search-input');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    // Reset filter checkboxes
                    document.querySelectorAll('.filter-options input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    
                    // Reset lists
                    updateNodeList('course', cy.nodes('[type = "course"]'));
                    updateNodeList('competency', cy.nodes('[type = "competency"]'));
                    updateNodeList('concept', cy.nodes('[type = "concept"]'));
                    
                    // Reset graph
                    cy.elements().removeClass('highlighted faded');
                    return;
                }
                
                // Search in graph nodes
                const matchingNodes = cy.nodes().filter(node => {
                    const data = node.data();
                    const name = data.name ? data.name.toLowerCase() : '';
                    const label = data.label ? data.label.toLowerCase() : '';
                    const id = data.id ? data.id.toLowerCase() : '';
                    
                    return name.includes(searchTerm) || label.includes(searchTerm) || id.includes(searchTerm);
                });
                
                // If nodes found, highlight them
                if (matchingNodes.length > 0) {
                    // Highlight matching nodes
                    cy.elements().addClass('faded');
                    matchingNodes.removeClass('faded').addClass('highlighted');
                    
                    // Fit view to matching nodes
                    cy.fit(matchingNodes, 50);
                }
                
                // Update lists
                updateNodeList('course', matchingNodes.filter('[type = "course"]'));
                updateNodeList('competency', matchingNodes.filter('[type = "competency"]'));
                updateNodeList('concept', matchingNodes.filter('[type = "concept"]'));
            });
        }
        
        // Initialize mode switching
        function initializeModeSwitching(data) {
            const modeButtons = document.querySelectorAll('.mode-button');
            
            modeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Get the mode
                    const mode = this.getAttribute('data-mode');
                    
                    // Remove active class from all buttons
                    modeButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to this button
                    this.classList.add('active');
                    
                    // Switch mode
                    switchMode(mode);
                });
            });
        }
        
        // Switch mode
        function switchMode(mode) {
            // Get the visualization area
            const visualizationArea = document.querySelector('.visualization-area');
            
            // Show/hide graph and controls based on mode
            const graphContainer = document.getElementById('graph-container');
            const controlsOverlay = document.querySelector('.controls-overlay');
            const layoutControls = document.querySelector('.layout-controls');
            const graphLegend = document.querySelector('.graph-legend');
            
            // Show graph and controls only in explore mode
            if (mode === 'explore') {
                graphContainer.style.display = 'block';
                controlsOverlay.style.display = 'block';
                layoutControls.style.display = 'block';
                graphLegend.style.display = 'block';
                
                // Restore any mode-specific container
                const modeContainer = visualizationArea.querySelector('.mode-container');
                if (modeContainer) {
                    modeContainer.remove();
                }
                
                return;
            }
            
            // Hide graph and controls for other modes
            graphContainer.style.display = 'none';
            controlsOverlay.style.display = 'none';
            layoutControls.style.display = 'none';
            graphLegend.style.display = 'none';
            
            // Remove any existing mode container
            const existingContainer = visualizationArea.querySelector('.mode-container');
            if (existingContainer) {
                existingContainer.remove();
            }
            
            // Create mode-specific container
            const modeContainer = document.createElement('div');
            modeContainer.className = 'mode-container';
            modeContainer.style.height = '100%';
            modeContainer.style.overflowY = 'auto';
            modeContainer.style.padding = '1.5rem';
            
            // Fill container based on mode
            switch(mode) {
                case 'analyze':
                    modeContainer.innerHTML = createAnalyzeMode();
                    break;
                case 'learning-path':
                    modeContainer.innerHTML = createLearningPathMode();
                    break;
                case 'report':
                    modeContainer.innerHTML = createReportMode();
                    break;
            }
            
            // Add container to visualization area
            visualizationArea.appendChild(modeContainer);
            
            // Initialize mode-specific functionality
            if (mode === 'analyze') {
                initializeAnalyzeMode();
            } else if (mode === 'learning-path') {
                initializeLearningPathMode();
            } else if (mode === 'report') {
                initializeReportMode();
            }
        }
        
        // Create analyze mode content
        function createAnalyzeMode() {
            return `
                <div class="bg-white rounded-lg shadow-md p-5 mb-5">
                    <h2 class="text-xl font-bold mb-3 text-primary">Análisis del Ecosistema de Conocimiento</h2>
                    
                    <div class="mb-5">
                        <h3 class="font-bold mb-2 text-lg text-primary flex items-center">
                            <i class="fas fa-sitemap mr-2"></i> Análisis de Estructura
                        </h3>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Cobertura de Áreas Temáticas</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="area-coverage-chart" style="height: 300px;"></div>
                                <p class="mt-2 text-sm">Este análisis muestra la distribución de actividades formativas por área temática, ayudando a identificar áreas subrepresentadas o sobrerepresentadas.</p>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Distribución de Niveles de Complejidad</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="complexity-chart" style="height: 250px;"></div>
                                <p class="mt-2 text-sm">Visualiza la distribución de actividades según su nivel de dificultad, importante para asegurar una progresión adecuada en las rutas formativas.</p>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Mapa de Conceptos y Competencias</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="md:w-1/2">
                                        <h4 class="font-semibold mb-2">Distribución de Competencias por Tipo</h4>
                                        <div id="competency-type-chart" style="height: 250px;"></div>
                                    </div>
                                    <div class="md:w-1/2">
                                        <h4 class="font-semibold mb-2">Niveles Taxonómicos (Bloom)</h4>
                                        <div id="bloom-level-chart" style="height: 250px;"></div>
                                    </div>
                                </div>
                                <p class="mt-2 text-sm">Muestra la relación entre conceptos jurídicos y competencias profesionales, revelando cómo el conocimiento teórico sustenta habilidades prácticas.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2 text-lg text-primary flex items-center">
                            <i class="fas fa-search mr-2"></i> Análisis de Vacíos y Oportunidades
                        </h3>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Competencias Sin Cobertura Adecuada</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="competency-gaps" class="mt-2">
                                    <p class="text-sm italic">Analizando las competencias con menor cobertura en el plan formativo...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Áreas Emergentes No Cubiertas</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="emerging-areas" class="mt-2">
                                    <p class="text-sm italic">Analizando tendencias jurídicas y comparando con la oferta formativa actual...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Recomendaciones Estratégicas</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="strategic-recommendations" class="mt-2">
                                    <p class="text-sm italic">Generando recomendaciones basadas en el análisis del ecosistema...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h2 class="text-xl font-bold mb-3 text-primary">
                        <i class="fas fa-question-circle mr-2"></i> 
                        ¿Cómo mejora este ecosistema la formación judicial?
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="border border-gray-200 rounded-lg p-3">
                            <h3 class="font-semibold mb-2 text-primary">Calidad y Pertinencia</h3>
                            <p class="text-sm">El mapeo de relaciones entre cursos, competencias y conceptos permite ofrecer formación mejor alineada con las necesidades reales de los funcionarios judiciales.</p>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-3">
                            <h3 class="font-semibold mb-2 text-primary">Personalización</h3>
                            <p class="text-sm">Las rutas de aprendizaje personalizadas mejoran la eficiencia formativa al priorizar las competencias específicas requeridas por cada perfil profesional.</p>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-3">
                            <h3 class="font-semibold mb-2 text-primary">Coherencia Curricular</h3>
                            <p class="text-sm">La visualización del ecosistema completo permite identificar y corregir redundancias, vacíos y desconexiones en la oferta formativa.</p>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-3">
                            <h3 class="font-semibold mb-2 text-primary">Trazabilidad</h3>
                            <p class="text-sm">Se facilita el seguimiento desde las necesidades formativas hasta la verificación de impacto en el desempeño judicial.</p>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="font-semibold mb-2 text-primary">Impacto en la Administración de Justicia</h3>
                        <p class="mb-2">Al fortalecer sistemáticamente las competencias judiciales, el ecosistema contribuye a:</p>
                        <ul class="list-disc ml-5 text-sm">
                            <li>Mayor consistencia en decisiones judiciales</li>
                            <li>Reducción de tiempos procesales</li>
                            <li>Mejora en la fundamentación de resoluciones</li>
                            <li>Fortalecimiento de la confianza ciudadana en el sistema de justicia</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Create learning path mode content
        function createLearningPathMode() {
            return `
                <div class="bg-white rounded-lg shadow-md p-5 mb-5">
                    <h2 class="text-xl font-bold mb-3 text-primary">Rutas de Aprendizaje Personalizadas</h2>
                    
                    <p class="mb-5">Diseña itinerarios formativos adaptados a diferentes perfiles profesionales y necesidades específicas. Las rutas generadas consideran prerrequisitos, progresión de complejidad y cobertura temática integral.</p>
                    
                    <div class="mb-5">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="text-center text-3xl text-primary mb-2">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                                <h3 class="font-semibold text-center mb-2">Perfil Profesional</h3>
                                <p class="text-sm text-center text-gray-600">Selecciona el perfil para el que deseas crear la ruta (Juez de Paz, Primera Instancia, etc.).</p>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="text-center text-3xl text-primary mb-2">
                                    <i class="fas fa-sitemap"></i>
                                </div>
                                <h3 class="font-semibold text-center mb-2">Área de Interés</h3>
                                <p class="text-sm text-center text-gray-600">Elige el área temática específica para la especialización de la ruta.</p>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="text-center text-3xl text-primary mb-2">
                                    <i class="fas fa-sliders-h"></i>
                                </div>
                                <h3 class="font-semibold text-center mb-2">Parámetros Adicionales</h3>
                                <p class="text-sm text-center text-gray-600">Ajusta la duración, enfoque y otros parámetros para personalizar la ruta.</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button id="create-learning-path-btn" class="btn-primary py-3 px-6">
                                <i class="fas fa-route mr-2"></i> Crear Nueva Ruta de Aprendizaje
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-5">
                        <h3 class="font-semibold mb-3 text-primary">Rutas Predefinidas</h3>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por perfil:</label>
                            <select id="predefined-path-filter" class="w-full p-2 border border-gray-300 rounded">
                                <option value="all">Todos los perfiles</option>
                                <option value="juez_paz">Juez/a de Paz</option>
                                <option value="juez_primera">Juez/a de Primera Instancia</option>
                                <option value="magistrado">Magistrado/a</option>
                                <option value="auxiliar">Personal Auxiliar</option>
                            </select>
                        </div>
                        
                        <div id="predefined-paths-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <!-- Ruta predefinida 1 -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">Formación Básica para Jueces de Paz</h4>
                                    <span class="badge badge-primary">Juez/a de Paz</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">Ruta formativa integral para jueces de paz recién nombrados, cubriendo aspectos jurisdiccionales y de gestión.</p>
                                <div class="flex justify-between items-center mt-3 text-sm">
                                    <span><i class="far fa-calendar-alt mr-1"></i> 6 meses</span>
                                    <span><i class="fas fa-layer-group mr-1"></i> 8 cursos</span>
                                    <a href="#" class="text-primary hover:underline"><i class="fas fa-eye mr-1"></i> Ver detalles</a>
                                </div>
                            </div>
                            
                            <!-- Ruta predefinida 2 -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">Especialización en Derecho Penal</h4>
                                    <span class="badge badge-info">Juez/a Primera Instancia</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">Ruta especializada en materia penal para jueces de primera instancia, con énfasis en valoración probatoria.</p>
                                <div class="flex justify-between items-center mt-3 text-sm">
                                    <span><i class="far fa-calendar-alt mr-1"></i> 9 meses</span>
                                    <span><i class="fas fa-layer-group mr-1"></i> 12 cursos</span>
                                    <a href="#" class="text-primary hover:underline"><i class="fas fa-eye mr-1"></i> Ver detalles</a>
                                </div>
                            </div>
                            
                            <!-- Ruta predefinida 3 -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">Gestión de Despacho Judicial</h4>
                                    <span class="badge badge-success">Auxiliar Judicial</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">Ruta formativa centrada en las competencias de gestión y organización para personal auxiliar judicial.</p>
                                <div class="flex justify-between items-center mt-3 text-sm">
                                    <span><i class="far fa-calendar-alt mr-1"></i> 4 meses</span>
                                    <span><i class="fas fa-layer-group mr-1"></i> 6 cursos</span>
                                    <a href="#" class="text-primary hover:underline"><i class="fas fa-eye mr-1"></i> Ver detalles</a>
                                </div>
                            </div>
                            
                            <!-- Ruta predefinida 4 -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">Actualización en Jurisprudencia</h4>
                                    <span class="badge badge-warning">Magistrado/a</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">Ruta de actualización avanzada para magistrados sobre tendencias jurisprudenciales nacionales e internacionales.</p>
                                <div class="flex justify-between items-center mt-3 text-sm">
                                    <span><i class="far fa-calendar-alt mr-1"></i> 3 meses</span>
                                    <span><i class="fas fa-layer-group mr-1"></i> 5 cursos</span>
                                    <a href="#" class="text-primary hover:underline"><i class="fas fa-eye mr-1"></i> Ver detalles</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h2 class="text-xl font-bold mb-3 text-primary">
                        <i class="fas fa-lightbulb mr-2"></i>
                        Beneficios de las Rutas de Aprendizaje
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-primary text-xl mr-3">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-1">Aprendizaje Progresivo</h3>
                                <p class="text-sm text-gray-600">Secuencia lógica desde conceptos básicos hasta avanzados, asegurando una progresión adecuada.</p>
                            </div>
                        </div>
                        
                        <div class="flex">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-primary text-xl mr-3">
                                <i class="fas fa-user-cog"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-1">Personalización</h3>
                                <p class="text-sm text-gray-600">Adaptación a las necesidades específicas de cada perfil y función jurisdiccional.</p>
                            </div>
                        </div>
                        
                        <div class="flex">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-primary text-xl mr-3">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-1">Cobertura Completa</h3>
                                <p class="text-sm text-gray-600">Garantiza que se aborden todas las competencias necesarias para el desempeño óptimo.</p>
                            </div>
                        </div>
                        
                        <div class="flex">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-primary text-xl mr-3">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-1">Optimización de Tiempo</h3>
                                <p class="text-sm text-gray-600">Evita redundancias y se enfoca en las áreas de mayor impacto para cada funcionario.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex items-center">
                            <i class="fas fa-quote-left text-2xl text-primary opacity-50 mr-3"></i>
                            <p class="italic">
                                "Las rutas de aprendizaje personalizadas han transformado nuestra formación judicial, permitiéndonos aplicar los conocimientos de manera más efectiva en nuestra labor diaria."
                                <span class="block mt-1 text-sm font-semibold">— Juez de Primera Instancia, Ramo Penal</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Create report mode content
        function createReportMode() {
            return `
                <div class="bg-white rounded-lg shadow-md p-5 mb-5">
                    <h2 class="text-xl font-bold mb-3 text-primary">Reportes del Ecosistema de Formación</h2>
                    
                    <div class="mb-5">
                        <h3 class="font-bold mb-2 text-lg text-primary flex items-center">
                            <i class="fas fa-chart-line mr-2"></i> Reportes Estratégicos
                        </h3>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Análisis de Alineación Estratégica</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <p class="mb-2">Este reporte evalúa la alineación entre las actividades formativas y las prioridades estratégicas institucionales:</p>
                                <div id="strategic-alignment-chart" style="height: 250px;"></div>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Mapa de Ruta Curricular</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <p class="mb-2">Visualización de posibles trayectorias formativas para diferentes perfiles judiciales:</p>
                                <div id="curriculum-path" style="height: 300px;"></div>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Estado General del Ecosistema</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                                    <div class="border border-gray-200 rounded-lg p-3 text-center">
                                        <div class="text-3xl font-bold text-primary mb-1" id="courses-count">--</div>
                                        <div class="text-sm font-medium">Cursos</div>
                                    </div>
                                    <div class="border border-gray-200 rounded-lg p-3 text-center">
                                        <div class="text-3xl font-bold text-blue-500 mb-1" id="competencies-count">--</div>
                                        <div class="text-sm font-medium">Competencias</div>
                                    </div>
                                    <div class="border border-gray-200 rounded-lg p-3 text-center">
                                        <div class="text-3xl font-bold text-green-500 mb-1" id="concepts-count">--</div>
                                        <div class="text-sm font-medium">Conceptos</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="font-semibold mb-1">Salud del Ecosistema:</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-green-600 h-2.5 rounded-full" style="width: 78%"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">78% - Buena. Oportunidades de mejora en áreas específicas.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2 text-lg text-primary flex items-center">
                            <i class="fas fa-file-alt mr-2"></i> Reportes Operativos
                        </h3>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Resumen de Cobertura Formativa</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="coverage-summary" class="mt-2">
                                    <p>Generando resumen de cobertura formativa por área y perfil profesional...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Evaluación de Coherencia Curricular</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div id="curricular-coherence" class="mt-2">
                                    <p>Analizando la coherencia entre objetivos, competencias, metodologías y evaluación...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-container">
                            <div class="accordion-header">
                                <span>Generar Reporte Personalizado</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="accordion-content">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Reporte:</label>
                                    <select id="report-type" class="w-full p-2 border border-gray-300 rounded">
                                        <option value="comprehensive">Reporte Completo</option>
                                        <option value="coverage">Cobertura por Área</option>
                                        <option value="competency">Análisis de Competencias</option>
                                        <option value="gap">Análisis de Brechas</option>
                                        <option value="executive">Resumen Ejecutivo</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Perfil:</label>
                                    <select id="report-profile" class="w-full p-2 border border-gray-300 rounded">
                                        <option value="all">Todos los Perfiles</option>
                                        <option value="juez_paz">Juez/a de Paz</option>
                                        <option value="juez_primera">Juez/a de Primera Instancia</option>
                                        <option value="magistrado">Magistrado/a</option>
                                        <option value="auxiliar">Personal Auxiliar</option>
                                    </select>
                                </div>
                                <button id="generate-report-btn" class="btn-primary">
                                    <i class="fas fa-file-export mr-2"></i> Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h2 class="text-xl font-bold mb-3 text-primary">
                        <i class="fas fa-brain mr-2"></i>
                        Modelado Ontológico y Planificación Asistida
                    </h2>
                    
                    <p class="mb-4">El Ecosistema Inteligente de Conocimiento implementa un modelo innovador que integra:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold mb-2 text-primary">Sistema Vivo de Planificación Educativa</h3>
                            <p class="text-sm mb-3">Un sistema asistido por IA que guía la creación de contenido formativo estructurado semánticamente, facilitando:</p>
                            <ul class="list-disc ml-5 text-sm">
                                <li>Asistencia contextual en la planificación</li>
                                <li>Tokenización semántica del contenido</li>
                                <li>Versionamiento microtemporal</li>
                                <li>Evaluación asistida y validación</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold mb-2 text-primary">Modelo Ontológico para la Formación Judicial</h3>
                            <p class="text-sm mb-3">Una estructura semántica que organiza y conecta todo el conocimiento académico institucional mediante:</p>
                            <ul class="list-disc ml-5 text-sm">
                                <li>Clasificación académico-administrativa</li>
                                <li>Clasificación temático-taxonómica</li>
                                <li>Taxonomía global enriquecida</li>
                                <li>Relaciones semánticas contextualizadas</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="font-semibold mb-2 text-primary">Capacidades Emergentes</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <div class="font-medium mb-1">Trazabilidad Completa</div>
                                <p class="text-xs">Seguimiento integral desde necesidades hasta impacto.</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg">
                                <div class="font-medium mb-1">Personalización Basada en Competencias</div>
                                <p class="text-xs">Rutas formativas adaptadas a perfiles específicos.</p>
                            </div>
                            <div class="p-3 bg-amber-50 rounded-lg">
                                <div class="font-medium mb-1">Gestión del Conocimiento</div>
                                <p class="text-xs">Capitalización y preservación del conocimiento institucional.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // Add global chart variables
        let areaChart = null;
        let complexityChart = null;
        let competencyTypeChart = null;
        let bloomLevelChart = null;
        
        // Initialize analyze mode
        function initializeAnalyzeMode() {
            // Initialize accordions
            initializeAccordions();
            
            // Add click handlers to accordions that contain charts
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    
                    // If the accordion is being opened and contains chart containers
                    if (!content.classList.contains('active')) {
                        // Add a small delay to ensure DOM is updated
                        setTimeout(() => {
                            const chartContainers = content.querySelectorAll('[id$="-chart"]');
                            if (chartContainers.length > 0) {
                                // Create charts for this section
                                createChartsInContainer(content);
                            }
                        }, 300);
                    }
                });
            });
            
            // Initialize with first accordion open
            const firstAccordion = document.querySelector('.accordion-header');
            if (firstAccordion) {
                firstAccordion.click();
            }
            
            // Fill gaps and recommendations content
            setTimeout(() => {
                fillCompetencyGaps();
                fillEmergingAreas();
                fillStrategicRecommendations();
            }, 1000);
        }

        // Function to create charts in a container
        
        function createChartsInContainer(container) {
            // Get chart containers if they exist in this section
            const areaCoverageChart = container.querySelector('#area-coverage-chart');
            const complexityChart = container.querySelector('#complexity-chart');
            const competencyTypeChart = container.querySelector('#competency-type-chart');
            const bloomLevelChart = container.querySelector('#bloom-level-chart');
            
            // Only create charts for containers that exist and are visible
            if (areaCoverageChart && isElementVisible(areaCoverageChart)) {
                createAreaCoverageChart(areaCoverageChart);
            }
            
            if (complexityChart && isElementVisible(complexityChart)) {
                createComplexityChart(complexityChart);
            }
            
            if (competencyTypeChart && isElementVisible(competencyTypeChart)) {
                createCompetencyTypeChart(competencyTypeChart);
            }
            
            if (bloomLevelChart && isElementVisible(bloomLevelChart)) {
                createBloomLevelChart(bloomLevelChart);
            }
        }

        // Helper function to check if element is visible
        function isElementVisible(element) {
            return element.offsetWidth > 0 && element.offsetHeight > 0;
        }

        // Create area coverage chart with error handling
        function createAreaCoverageChart(container) {
            // Destroy previous chart if exists
            if (areaChart) {
                areaChart.destroy();
            }
            
            // Verify the container is valid
            if (!container || !container.getContext) {
                console.error('Invalid chart container for area coverage chart');
                return;
            }
            
            try {
                // Extract areas from data
                const areas = {};
                if (window.cy) {
                    cy.nodes('[type = "course"]').forEach(node => {
                        const area = node.data('nodeData').area_organizativa_pfjya || 'No especificada';
                        areas[area] = (areas[area] || 0) + 1;
                    });
                }
                
                // Ensure we have data (if not, use sample data)
                if (Object.keys(areas).length === 0) {
                    areas['Especialización Judicial'] = 25;
                    areas['Derecho Penal'] = 18;
                    areas['Derecho Civil'] = 15;
                    areas['Derecho Constitucional'] = 12;
                    areas['Métodos Alternativos'] = 8;
                }
                
                // Prepare data for chart
                const labels = Object.keys(areas);
                const data = Object.values(areas);
                
                // Create chart
                areaChart = new Chart(container.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cursos por Área',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Cursos'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Área Temática'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        return `Cursos: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error creating area coverage chart:', e);
                container.innerHTML = `<div class="p-4 text-center text-red-500">Error al crear el gráfico: ${e.message}</div>`;
            }
        }

        // Create complexity chart with error handling
        function createComplexityChart(container) {
            // Destroy previous chart if exists
            if (complexityChart) {
                complexityChart.destroy();
            }
            
            // Verify the container is valid
            if (!container || !container.getContext) {
                console.error('Invalid chart container for complexity chart');
                return;
            }
            
            try {
                // Extract complexity levels from data
                const complexity = {};
                if (window.cy) {
                    cy.nodes('[type = "course"]').forEach(node => {
                        const level = node.data('nodeData').nivel_dificultad || 'No especificado';
                        complexity[level] = (complexity[level] || 0) + 1;
                    });
                }
                
                // Ensure we have data (if not, use sample data)
                if (Object.keys(complexity).length === 0) {
                    complexity['Básico'] = 20;
                    complexity['Intermedio'] = 35;
                    complexity['Avanzado'] = 15;
                    complexity['No especificado'] = 5;
                }
                
                // Prepare data for chart
                const labels = Object.keys(complexity);
                const data = Object.values(complexity);
                const backgroundColors = [
                    'rgba(16, 185, 129, 0.7)',  // Green
                    'rgba(59, 130, 246, 0.7)',  // Blue
                    'rgba(245, 158, 11, 0.7)',  // Amber
                    'rgba(156, 163, 175, 0.7)'  // Gray
                ];
                
                // Create chart
                complexityChart = new Chart(container.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: 'white',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error creating complexity chart:', e);
                container.innerHTML = `<div class="p-4 text-center text-red-500">Error al crear el gráfico: ${e.message}</div>`;
            }
        }

        // Create competency type chart with error handling
        function createCompetencyTypeChart(container) {
            // Destroy previous chart if exists
            if (competencyTypeChart) {
                competencyTypeChart.destroy();
            }
            
            // Verify the container is valid
            if (!container || !container.getContext) {
                console.error('Invalid chart container for competency type chart');
                return;
            }
            
            try {
                // Extract competency types
                const competencyTypes = {
                    'Técnica-Jurídica': 0,
                    'Ética y Valores': 0,
                    'Comunicativa': 0,
                    'Analítica': 0,
                    'Gestión y Liderazgo': 0,
                    'General': 0
                };
                
                // Count each type
                if (window.cy) {
                    cy.nodes('[type = "competency"]').forEach(node => {
                        const competency = node.data('nodeData').competencia;
                        const type = determineCompetencyTypeText(competency);
                        competencyTypes[type]++;
                    });
                }
                
                // Ensure we have data (if not, use sample data)
                if (Object.values(competencyTypes).every(value => value === 0)) {
                    competencyTypes['Técnica-Jurídica'] = 45;
                    competencyTypes['Ética y Valores'] = 15;
                    competencyTypes['Comunicativa'] = 20;
                    competencyTypes['Analítica'] = 25;
                    competencyTypes['Gestión y Liderazgo'] = 18;
                    competencyTypes['General'] = 10;
                }
                
                // Prepare data for chart
                const labels = Object.keys(competencyTypes);
                const data = Object.values(competencyTypes);
                const backgroundColors = [
                    'rgba(59, 130, 246, 0.7)',  // Blue
                    'rgba(16, 185, 129, 0.7)',  // Green
                    'rgba(245, 158, 11, 0.7)',  // Amber
                    'rgba(124, 58, 237, 0.7)',  // Purple
                    'rgba(239, 68, 68, 0.7)',   // Red
                    'rgba(156, 163, 175, 0.7)'  // Gray
                ];
                
                // Create chart
                competencyTypeChart = new Chart(container.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: 'white',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error creating competency type chart:', e);
                container.innerHTML = `<div class="p-4 text-center text-red-500">Error al crear el gráfico: ${e.message}</div>`;
            }
        }

        // Create Bloom level chart with error handling
        function createBloomLevelChart(container) {
            // Destroy previous chart if exists
            if (bloomLevelChart) {
                bloomLevelChart.destroy();
            }
            
            // Verify the container is valid
            if (!container || !container.getContext) {
                console.error('Invalid chart container for bloom level chart');
                return;
            }
            
            try {
                // Extract Bloom levels
                const bloomLevels = {
                    'Conocimiento': 0,
                    'Comprensión': 0,
                    'Aplicación': 0,
                    'Análisis': 0,
                    'Evaluación': 0,
                    'Creación': 0,
                    'No determinado': 0
                };
                
                // Count each level
                if (window.cy) {
                    cy.nodes('[type = "competency"]').forEach(node => {
                        const competency = node.data('nodeData').competencia;
                        const level = determineBloomLevelText(competency);
                        bloomLevels[level]++;
                    });
                }
                
                // Ensure we have data (if not, use sample data)
                if (Object.values(bloomLevels).every(value => value === 0)) {
                    bloomLevels['Conocimiento'] = 15;
                    bloomLevels['Comprensión'] = 25;
                    bloomLevels['Aplicación'] = 40;
                    bloomLevels['Análisis'] = 35;
                    bloomLevels['Evaluación'] = 20;
                    bloomLevels['Creación'] = 10;
                    bloomLevels['No determinado'] = 5;
                }
                
                // Prepare data for chart
                const labels = Object.keys(bloomLevels);
                const data = Object.values(bloomLevels);
                const backgroundColors = [
                    'rgba(156, 163, 175, 0.7)',  // Gray
                    'rgba(96, 165, 250, 0.7)',   // Light Blue
                    'rgba(59, 130, 246, 0.7)',   // Blue
                    'rgba(16, 185, 129, 0.7)',   // Green
                    'rgba(245, 158, 11, 0.7)',   // Amber
                    'rgba(239, 68, 68, 0.7)',    // Red
                    'rgba(209, 213, 219, 0.7)'   // Light Gray
                ];
                
                // Create chart
                bloomLevelChart = new Chart(container.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: 'white',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Competencias: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Competencias'
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error creating bloom level chart:', e);
                container.innerHTML = `<div class="p-4 text-center text-red-500">Error al crear el gráfico: ${e.message}</div>`;
            }
        }
        
        // Get competency type text
        function determineCompetencyTypeText(text) {
            if (!text) return 'General';
            
            text = text.toLowerCase();
            
            if (text.includes('ética') || text.includes('valores') || text.includes('integridad') || text.includes('responsabilidad')) {
                return 'Ética y Valores';
            } else if (text.includes('comunicación') || text.includes('expresión') || text.includes('redacción') || text.includes('exposición')) {
                return 'Comunicativa';
            } else if (text.includes('análisis') || text.includes('investigación') || text.includes('razonamiento') || text.includes('pensamiento crítico')) {
                return 'Analítica';
            } else if (text.includes('gestión') || text.includes('dirección') || text.includes('liderazgo') || text.includes('organización')) {
                return 'Gestión y Liderazgo';
            } else if (text.includes('técnica') || text.includes('procesal') || text.includes('jurídica') || text.includes('normativa')) {
                return 'Técnica-Jurídica';
            } else {
                return 'General';
            }
        }
        
        // Get Bloom level text
        function determineBloomLevelText(text) {
            if (!text) return 'No determinado';
            
            text = text.toLowerCase();
            
            if (text.includes('crear') || text.includes('diseñar') || text.includes('producir') || text.includes('generar')) {
                return 'Creación';
            } else if (text.includes('evaluar') || text.includes('valorar') || text.includes('justificar') || text.includes('criticar')) {
                return 'Evaluación';
            } else if (text.includes('analizar') || text.includes('diferenciar') || text.includes('organizar') || text.includes('comparar')) {
                return 'Análisis';
            } else if (text.includes('aplicar') || text.includes('desarrollar') || text.includes('implementar') || text.includes('utilizar')) {
                return 'Aplicación';
            } else if (text.includes('comprender') || text.includes('explicar') || text.includes('interpretar') || text.includes('describir')) {
                return 'Comprensión';
            } else if (text.includes('reconocer') || text.includes('recordar') || text.includes('identificar') || text.includes('listar')) {
                return 'Conocimiento';
            } else {
                return 'No determinado';
            }
        }
        
        // Fill competency gaps analysis
        function fillCompetencyGaps() {
            const container = document.getElementById('competency-gaps');
            if (!container) return;
            
            container.innerHTML = `
                <div class="mb-2">
                    <p class="mb-2">El análisis identifica competencias con potencial brecha de cobertura:</p>
                    <div class="p-2 border border-orange-300 bg-orange-50 rounded mb-2">
                        <strong>Competencia 1:</strong> Aplicación de criterios sobre pluralismo jurídico en contextos interculturales.
                        <div class="text-sm text-gray-700 mt-1">Cobertura actual: 15% | Recomendación: Incluir en nuevos cursos específicos.</div>
                    </div>
                    <div class="p-2 border border-orange-300 bg-orange-50 rounded mb-2">
                        <strong>Competencia 2:</strong> Análisis de evidencia digital y prueba electrónica en procesos judiciales.
                        <div class="text-sm text-gray-700 mt-1">Cobertura actual: 25% | Recomendación: Fortalecer en cursos de actualización.</div>
                    </div>
                    <div class="p-2 border border-orange-300 bg-orange-50 rounded">
                        <strong>Competencia 3:</strong> Aplicación de estándares internacionales en casos de violencia de género.
                        <div class="text-sm text-gray-700 mt-1">Cobertura actual: 40% | Recomendación: Expandir en módulos existentes.</div>
                    </div>
                </div>
            `;
        }
        
        // Fill emerging areas analysis
        function fillEmergingAreas() {
            const container = document.getElementById('emerging-areas');
            if (!container) return;
            
            container.innerHTML = `
                <div>
                    <p class="mb-2">Análisis de tendencias jurídicas emergentes con baja representación en la oferta formativa actual:</p>
                    <div class="p-2 border border-blue-300 bg-blue-50 rounded mb-2">
                        <strong>Justicia Digital y Ciberseguridad</strong>
                        <div class="text-sm text-gray-700 mt-1">Representación actual: 10% | Relevancia proyectada: Alta</div>
                    </div>
                    <div class="p-2 border border-blue-300 bg-blue-50 rounded mb-2">
                        <strong>Inteligencia Artificial en la Toma de Decisiones Judiciales</strong>
                        <div class="text-sm text-gray-700 mt-1">Representación actual: 5% | Relevancia proyectada: Crítica</div>
                    </div>
                    <div class="p-2 border border-blue-300 bg-blue-50 rounded">
                        <strong>Derecho Ambiental y Justicia Climática</strong>
                        <div class="text-sm text-gray-700 mt-1">Representación actual: 15% | Relevancia proyectada: Alta</div>
                    </div>
                </div>
            `;
        }
        
        // Fill strategic recommendations
        function fillStrategicRecommendations() {
            const container = document.getElementById('strategic-recommendations');
            if (!container) return;
            
            container.innerHTML = `
                <div>
                    <p class="mb-2">Recomendaciones estratégicas basadas en el análisis integral del ecosistema:</p>
                    <div class="p-2 border border-green-300 bg-green-50 rounded mb-2">
                        <strong>1. Fortalecimiento de competencias digitales</strong>
                        <div class="text-sm text-gray-700 mt-1">Desarrollar un programa integral de formación en justicia digital y tecnologías emergentes para todos los perfiles profesionales.</div>
                    </div>
                    <div class="p-2 border border-green-300 bg-green-50 rounded mb-2">
                        <strong>2. Integración de enfoque intercultural</strong>
                        <div class="text-sm text-gray-700 mt-1">Incorporar transversalmente el enfoque de pluralismo jurídico en las actividades formativas existentes.</div>
                    </div>
                    <div class="p-2 border border-green-300 bg-green-50 rounded">
                        <strong>3. Evolución a modelo por competencias</strong>
                        <div class="text-sm text-gray-700 mt-1">Implementar formalmente un marco de competencias judiciales y alinear toda la oferta formativa a este enfoque.</div>
                    </div>
                </div>
            `;
        }
        
        // Initialize learning path mode
        function initializeLearningPathMode() {
            // Initialize accordions
            initializeAccordions();
            
            // Add event listener to create path button
            document.getElementById('create-learning-path-btn').addEventListener('click', function() {
                openLearningPathModal();
            });
            
            // Initialize predefined path filter
            const pathFilter = document.getElementById('predefined-path-filter');
            if (pathFilter) {
                pathFilter.addEventListener('change', function() {
                    filterPredefinedPaths(this.value);
                });
            }
            
            // Add event listeners to path details links
            document.querySelectorAll('#predefined-paths-container a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPathDetails(this.closest('.border'));
                });
            });
        }
        
        // Filter predefined paths
        function filterPredefinedPaths(profile) {
            const pathContainer = document.getElementById('predefined-paths-container');
            const paths = pathContainer.querySelectorAll('.border');
            
            paths.forEach(path => {
                const pathProfile = path.querySelector('.badge').textContent.toLowerCase();
                
                if (profile === 'all' || pathProfile.includes(profile.replace('_', ' '))) {
                    path.style.display = 'block';
                } else {
                    path.style.display = 'none';
                }
            });
        }
        
        // Show path details
        function showPathDetails(pathElement) {
            const pathTitle = pathElement.querySelector('h4').textContent;
            
            // Open learning path modal
            openLearningPathModal();
            
            // Set path title
            setTimeout(() => {
                // Set profile based on badge
                const badge = pathElement.querySelector('.badge').textContent.toLowerCase();
                let profile = 'juez_paz'; // Default
                
                if (badge.includes('primera instancia')) {
                    profile = 'juez_primera';
                } else if (badge.includes('magistrado')) {
                    profile = 'magistrado';
                } else if (badge.includes('auxiliar')) {
                    profile = 'auxiliar';
                }
                
                document.getElementById('profile-selector').value = profile;
                
                // Generate path (simulating a click)
                document.getElementById('generate-path-btn').click();
            }, 200);
        }
        
        // Initialize report mode
        function initializeReportMode() {
            // Initialize accordions
            initializeAccordions();
            
            // Fill counts
            const coursesCount = document.getElementById('courses-count');
            const competenciesCount = document.getElementById('competencies-count');
            const conceptsCount = document.getElementById('concepts-count');
            
            if (coursesCount) {
                coursesCount.textContent = cy.nodes('[type = "course"]').length;
            }
            
            if (competenciesCount) {
                competenciesCount.textContent = cy.nodes('[type = "competency"]').length;
            }
            
            if (conceptsCount) {
                conceptsCount.textContent = cy.nodes('[type = "concept"]').length;
            }
            
            // Create strategic alignment chart
            const alignmentChart = document.getElementById('strategic-alignment-chart');
            if (alignmentChart) {
                createStrategicAlignmentChart(alignmentChart);
            }
            
            // Create curriculum path visualization
            const curriculumPath = document.getElementById('curriculum-path');
            if (curriculumPath) {
                createCurriculumPathVisualization(curriculumPath);
            }
            
            // Fill coverage summary
            setTimeout(() => {
                fillCoverageSummary();
            }, 500);
            
            // Fill curricular coherence
            setTimeout(() => {
                fillCurricularCoherence();
            }, 700);
            
            // Add event listener to generate report button
            const generateReportBtn = document.getElementById('generate-report-btn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', function() {
                    generateReport();
                });
            }
        }
        
        // Create strategic alignment chart
        function createStrategicAlignmentChart(container) {
            // Define strategic objectives
            const objectives = [
                'Fortalecimiento Capacidades Técnicas',
                'Transformación Digital',
                'Acceso a Justicia',
                'Transparencia y Rendición de Cuentas',
                'Enfoque de Género'
            ];
            
            // Generate random scores for demo
            const scores = objectives.map(() => Math.floor(Math.random() * (95 - 60 + 1)) + 60);
            
            // Create chart
            new Chart(container, {
                type: 'bar',
                data: {
                    labels: objectives,
                    datasets: [{
                        label: 'Alineación Estratégica',
                        data: scores,
                        backgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            if (value > 80) return 'rgba(16, 185, 129, 0.7)';
                            if (value > 70) return 'rgba(59, 130, 246, 0.7)';
                            return 'rgba(245, 158, 11, 0.7)';
                        },
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje de Alineación'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Alineación: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create curriculum path visualization
        function createCurriculumPathVisualization(container) {
            // Simple colored boxes with arrows for demo
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                        <div class="flex flex-col items-center">
                            <div class="p-3 bg-gray-100 rounded-lg text-center w-48">
                                <div class="font-semibold text-primary">Niveles Básicos</div>
                                <div class="text-xs mt-1">Fundamentos y conceptos esenciales</div>
                            </div>
                            <div class="h-8 flex items-center">
                                <i class="fas fa-arrow-down text-primary"></i>
                            </div>
                        </div>
                        
                        <div class="hidden md:block w-8 h-8 flex items-center">
                            <i class="fas fa-arrow-right text-primary"></i>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="p-3 bg-blue-100 rounded-lg text-center w-48">
                                <div class="font-semibold text-primary">Niveles Intermedios</div>
                                <div class="text-xs mt-1">Aplicación y práctica</div>
                            </div>
                            <div class="h-8 flex items-center">
                                <i class="fas fa-arrow-down text-primary"></i>
                            </div>
                        </div>
                        
                        <div class="hidden md:block w-8 h-8 flex items-center">
                            <i class="fas fa-arrow-right text-primary"></i>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="p-3 bg-green-100 rounded-lg text-center w-48">
                                <div class="font-semibold text-primary">Niveles Avanzados</div>
                                <div class="text-xs mt-1">Especialización y profundización</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <p class="text-sm">Para visualizar una ruta formativa personalizada, utilice la opción "Crear Nueva Ruta" en la sección de Rutas de Aprendizaje.</p>
                        <button id="path-visualization-btn" class="btn-outline mt-3">
                            <i class="fas fa-route mr-2"></i> Ir a Rutas de Aprendizaje
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listener to button
            document.getElementById('path-visualization-btn').addEventListener('click', function() {
                // Switch to learning path mode
                document.querySelector('.mode-button[data-mode="learning-path"]').click();
            });
        }
        
        // Fill coverage summary
        function fillCoverageSummary() {
            const container = document.getElementById('coverage-summary');
            if (!container) return;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-3 border rounded">
                        <h4 class="font-bold mb-2">Cobertura por Área</h4>
                        <ul class="list-disc ml-5">
                            <li class="mb-1">Derecho Penal: <span class="font-semibold text-green-600">85%</span></li>
                            <li class="mb-1">Derecho Civil: <span class="font-semibold text-green-600">78%</span></li>
                            <li class="mb-1">Derecho Constitucional: <span class="font-semibold text-yellow-600">65%</span></li>
                            <li class="mb-1">Justicia Digital: <span class="font-semibold text-red-600">40%</span></li>
                            <li class="mb-1">Competencias Transversales: <span class="font-semibold text-green-600">72%</span></li>
                        </ul>
                    </div>
                    
                    <div class="p-3 border rounded">
                        <h4 class="font-bold mb-2">Cobertura por Perfil</h4>
                        <ul class="list-disc ml-5">
                            <li class="mb-1">Jueces/zas de Paz: <span class="font-semibold text-green-600">82%</span></li>
                            <li class="mb-1">Jueces/zas de Primera Instancia: <span class="font-semibold text-green-600">90%</span></li>
                            <li class="mb-1">Magistrados/as: <span class="font-semibold text-yellow-600">68%</span></li>
                            <li class="mb-1">Personal auxiliar: <span class="font-semibold text-yellow-600">61%</span></li>
                            <li class="mb-1">Personal administrativo: <span class="font-semibold text-red-600">45%</span></li>
                        </ul>
                    </div>
                </div>
                <div class="mt-4 p-3 border rounded">
                    <h4 class="font-bold mb-2">Recomendaciones Prioritarias</h4>
                    <ol class="list-decimal ml-5">
                        <li class="mb-1">Desarrollar oferta específica para personal administrativo.</li>
                        <li class="mb-1">Fortalecer formación en Justicia Digital para todos los perfiles.</li>
                        <li class="mb-1">Ampliar cobertura de competencias transversales, especialmente para magistrados/as.</li>
                    </ol>
                </div>
            `;
        }
        
        // Fill curricular coherence
        function fillCurricularCoherence() {
            const container = document.getElementById('curricular-coherence');
            if (!container) return;
            
            container.innerHTML = `
                <div class="p-3 border rounded mb-3">
                    <h4 class="font-bold mb-2">Análisis General</h4>
                    <p>El análisis de coherencia curricular muestra una alineación promedio del 78% entre objetivos, competencias y evaluación.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-3 text-left">Aspecto</th>
                                <th class="py-2 px-3 text-left">Coherencia</th>
                                <th class="py-2 px-3 text-left">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t">
                                <td class="py-2 px-3">Objetivo-Competencia</td>
                                <td class="py-2 px-3"><span class="font-semibold text-green-600">85%</span></td>
                                <td class="py-2 px-3">Alta coherencia en formulación</td>
                            </tr>
                            <tr class="border-t">
                                <td class="py-2 px-3">Competencia-Metodología</td>
                                <td class="py-2 px-3"><span class="font-semibold text-yellow-600">72%</span></td>
                                <td class="py-2 px-3">Oportunidad de mejora en alineación</td>
                            </tr>
                            <tr class="border-t">
                                <td class="py-2 px-3">Metodología-Evaluación</td>
                                <td class="py-2 px-3"><span class="font-semibold text-yellow-600">65%</span></td>
                                <td class="py-2 px-3">Recomendable reformular instrumentos</td>
                            </tr>
                            <tr class="border-t">
                                <td class="py-2 px-3">Objetivo-Evaluación</td>
                                <td class="py-2 px-3"><span class="font-semibold text-green-600">80%</span></td>
                                <td class="py-2 px-3">Alineación satisfactoria</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Generate report
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const profile = document.getElementById('report-profile').value;
            
            // Show loading notification
            showNotification(
                'Generando Reporte',
                'Preparando el reporte solicitado...',
                'info'
            );
            
            // Simulate report generation
            setTimeout(() => {
                showNotification(
                    'Reporte Generado',
                    'El reporte ha sido generado correctamente. Puede descargarlo a continuación.',
                    'success'
                );
                
                // Create download link
                const reportName = getReportName(reportType, profile);
                
                // Simulate download
                const tempLink = document.createElement('a');
                tempLink.href = '#';
                tempLink.download = reportName;
                tempLink.style.display = 'none';
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
            }, 1500);
        }
        
        // Get report name
        function getReportName(type, profile) {
            const date = new Date().toISOString().slice(0, 10);
            let typeName = '';
            let profileName = '';
            
            switch(type) {
                case 'comprehensive': typeName = 'Completo'; break;
                case 'coverage': typeName = 'Cobertura'; break;
                case 'competency': typeName = 'Competencias'; break;
                case 'gap': typeName = 'Brechas'; break;
                case 'executive': typeName = 'Ejecutivo'; break;
            }
            
            switch(profile) {
                case 'all': profileName = 'TodosPerfiles'; break;
                case 'juez_paz': profileName = 'JuecesPaz'; break;
                case 'juez_primera': profileName = 'JuecesPrimeraInstancia'; break;
                case 'magistrado': profileName = 'Magistrados'; break;
                case 'auxiliar': profileName = 'PersonalAuxiliar'; break;
            }
            
            return `Reporte_${typeName}_${profileName}_${date}.pdf`;
        }
        
        // Open learning path modal
        function openLearningPathModal() {
            // Get modal
            const modal = document.getElementById('learning-path-modal');
            
            // Get area selector
            const areaSelector = document.getElementById('area-selector');
            
            // Clear existing options except the first one (All)
            while (areaSelector.options.length > 1) {
                areaSelector.remove(1);
            }
            
            // Get unique areas from courses
            const areas = new Set();
            cy.nodes('[type = "course"]').forEach(node => {
                const area = node.data('nodeData').area_organizativa_pfjya;
                if (area) areas.add(area);
            });
            
            // Add areas to selector
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelector.appendChild(option);
            });
            
            // Reset path result container
            document.getElementById('path-result-container').classList.add('hidden');
            
            // Disable buttons
            document.getElementById('path-modal-save').disabled = true;
            if (document.getElementById('path-modal-export')) {
                document.getElementById('path-modal-export').disabled = true;
            }
            
            // Show modal
            modal.classList.add('active');
        }
        
        // Generate learning path
        function generateLearningPath() {
    // Get selected options
    const profile = document.getElementById('profile-selector').value;
    const area = document.getElementById('area-selector').value;
    const duration = document.getElementById('duration-slider').value;
    
    // Get selected focus badges
    const selectedFocus = [];
    document.querySelectorAll('.badge[data-focus].badge-primary').forEach(badge => {
        selectedFocus.push(badge.getAttribute('data-focus'));
    });
    
    // Show loading state
    const generateBtn = document.getElementById('generate-path-btn');
    const originalBtnText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generando...';
    generateBtn.disabled = true;
    
    try {
        // Validate that Cytoscape is initialized and has data
        if (!window.cy || cy.nodes().length === 0) {
            throw new Error('No hay datos disponibles para generar la ruta de aprendizaje');
        }
        
        // Simulate path generation (you can remove setTimeout in production)
        setTimeout(() => {
            // Reset button
            generateBtn.innerHTML = originalBtnText;
            generateBtn.disabled = false;
            
            // Generate path based on options
            generatePathContent(profile, area, duration, selectedFocus);
            
            // Show result container
            document.getElementById('path-result-container').classList.remove('hidden');
            
            // Enable buttons
            document.getElementById('path-modal-save').disabled = false;
            document.getElementById('path-modal-export').disabled = false;
            
            // Add handler for path modal save
            document.getElementById('path-modal-save').addEventListener('click', function() {
                saveGeneratedPath(profile, area, duration);
            });
            
            // Add handler for path modal export
            document.getElementById('path-modal-export').addEventListener('click', function() {
                exportGeneratedPath(profile, area, duration);
            });
            
            // Show notification
            showNotification(
                'Ruta de Aprendizaje Creada',
                `Se ha generado una ruta personalizada para ${getProfileLabel(profile)} con enfoque en ${area === 'all' ? 'todas las áreas' : area}.`,
                'success'
            );
        }, 1500);
    } catch (error) {
        console.error('Error generating learning path:', error);
        
        // Reset button
        generateBtn.innerHTML = originalBtnText;
        generateBtn.disabled = false;
        
        // Show error notification
        showNotification(
            'Error en Generación de Ruta',
            'Ha ocurrido un error al generar la ruta de aprendizaje: ' + error.message,
            'error'
        );
    }
}
        
        // Generate path content
        function generatePathContent(profile, area, duration, focus) {
            // Get containers
            const basicContainer = document.getElementById('basic-level-container');
            const intermediateContainer = document.getElementById('intermediate-level-container');
            const advancedContainer = document.getElementById('advanced-level-container');
            const pathSummary = document.getElementById('path-summary');
            
            // Clear containers
            basicContainer.innerHTML = '';
            intermediateContainer.innerHTML = '';
            advancedContainer.innerHTML = '';
            
            // Get courses from graph
            let courses = cy.nodes('[type = "course"]');
            
            // Filter by area if not "all"
            if (area !== 'all') {
                courses = courses.filter(node => {
                    return node.data('nodeData').area_organizativa_pfjya === area;
                });
            }
            
            // Filter for profile
            courses = filterCoursesByProfile(courses, profile);
            
            // Sort by level
            const basicCourses = courses.filter(node => {
                const level = node.data('nodeData').nivel_dificultad;
                return !level || level === 'Básico';
            });
            
            const intermediateCourses = courses.filter(node => {
                return node.data('nodeData').nivel_dificultad === 'Intermedio';
            });
            
            const advancedCourses = courses.filter(node => {
                return node.data('nodeData').nivel_dificultad === 'Avanzado';
            });
            
            // Limit based on duration
            const monthsPerCourse = 2;
            const totalCourses = Math.max(3, Math.floor(parseInt(duration) / monthsPerCourse));
            
            // Distribute courses among levels based on duration
            let basicCount = Math.max(1, Math.floor(totalCourses * 0.3));
            let intermediateCount = Math.max(1, Math.floor(totalCourses * 0.4));
            let advancedCount = Math.max(1, Math.floor(totalCourses * 0.3));
            
            // Ensure we don't exceed total available courses
            while (basicCount > basicCourses.length || 
                   intermediateCount > intermediateCourses.length || 
                   advancedCount > advancedCourses.length) {
                if (basicCount > basicCourses.length) {
                    const diff = basicCount - basicCourses.length;
                    basicCount = basicCourses.length;
                    intermediateCount += Math.floor(diff / 2);
                    advancedCount += Math.ceil(diff / 2);
                }
                if (intermediateCount > intermediateCourses.length) {
                    const diff = intermediateCount - intermediateCourses.length;
                    intermediateCount = intermediateCourses.length;
                    advancedCount += diff;
                }
                if (advancedCount > advancedCourses.length) {
                    advancedCount = advancedCourses.length;
                    break;
                }
            }
            
            // Create course cards for each level
            createCourseCards(basicCourses.slice(0, basicCount), basicContainer);
            createCourseCards(intermediateCourses.slice(0, intermediateCount), intermediateContainer);
            createCourseCards(advancedCourses.slice(0, advancedCount), advancedContainer);
            
            // Add empty state if needed
            if (basicCourses.length === 0) {
                basicContainer.innerHTML = '<div class="text-center p-3 text-gray-500 italic">No hay cursos básicos disponibles con los criterios seleccionados.</div>';
            }
            
            if (intermediateCourses.length === 0) {
                intermediateContainer.innerHTML = '<div class="text-center p-3 text-gray-500 italic">No hay cursos intermedios disponibles con los criterios seleccionados.</div>';
            }
            
            if (advancedCourses.length === 0) {
                advancedContainer.innerHTML = '<div class="text-center p-3 text-gray-500 italic">No hay cursos avanzados disponibles con los criterios seleccionados.</div>';
            }
            
            // Create path summary
            const totalCourseCount = basicCount + intermediateCount + advancedCount;
            pathSummary.innerHTML = `
                Ruta personalizada para <strong>${getProfileLabel(profile)}</strong>, con enfoque en 
                <strong>${area === 'all' ? 'todas las áreas' : area}</strong>, 
                duración estimada de <strong>${duration} meses</strong>, 
                que incluye <strong>${totalCourseCount} cursos</strong> 
                distribuidos en niveles básico, intermedio y avanzado.
                ${focus.length > 0 ? ' Con énfasis especial en: <strong>' + focus.map(f => formatFocusName(f)).join(', ') + '</strong>.' : ''}
            `;
        }
        
        // Filter courses by profile
        function filterCoursesByProfile(courses, profile) {
            // Define keywords for each profile
            const profileKeywords = {
                juez_paz: ['Paz', 'Facilitadores', 'Comunitaria', 'Local'],
                juez_primera: ['Primera Instancia', 'Jurisdiccional', 'Penal', 'Civil'],
                magistrado: ['Magistrado', 'Sala', 'Apelación', 'Superior'],
                auxiliar: ['Auxiliar', 'Técnico', 'Secretario', 'Asistente'],
                administrativo: ['Administrativo', 'Gestión', 'Administración']
            };
            
            // Get keywords for the selected profile
            const keywords = profileKeywords[profile] || [];
            
            // If no keywords, return all courses
            if (keywords.length === 0) return courses;
            
            // Filter courses by keywords
            return courses.filter(course => {
                const courseData = JSON.stringify(course.data('nodeData')).toLowerCase();
                return keywords.some(keyword => courseData.includes(keyword.toLowerCase()));
            });
        }
        
        // Create course cards
        function createCourseCards(courses, container) {
    courses.forEach((course, index) => {
        const courseData = course.data('nodeData');
        
        const card = document.createElement('div');
        card.className = 'course-card card-hover-effect fade-in';
        card.style.animationDelay = `${index * 0.1}s`;
        card.setAttribute('data-id', course.id());
        
        card.innerHTML = `
            <div class="course-card-title">${course.data('label')}: ${course.data('name')}</div>
            <div class="course-card-details">${truncateText(courseData.objetivo || '', 120)}</div>
            <div class="tag-wrapper">
                ${courseData.modalidad_general ? `<span class="tag">${courseData.modalidad_general}</span>` : ''}
                ${courseData.nivel_dificultad ? `<span class="tag">${courseData.nivel_dificultad}</span>` : ''}
            </div>
            <div class="course-card-meta">
                <span>
                    <i class="fas fa-clock"></i> 
                    ${courseData.horario && courseData.horario.duracion_total_horas ? courseData.horario.duracion_total_horas + ' horas' : 'Duración N/D'}
                </span>
                <span>
                    <i class="fas fa-calendar-alt"></i> 
                    ${courseData.bimestre_o_rango_bimestre || 'Periodo N/D'}
                </span>
            </div>
        `;
        
        // Add click event to show course details
        card.addEventListener('click', function() {
            // Add pulse effect when clicked
            this.classList.add('pulse-effect');
            
            // Find the node in the graph and show details
            const node = cy.getElementById(course.id());
            highlightNode(node);
            showNodeDetail(node);
            
            // Remove pulse effect after animation completes
            setTimeout(() => {
                this.classList.remove('pulse-effect');
            }, 2000);
        });
        
        container.appendChild(card);
    });
}
        
        // Save generated path
        function saveGeneratedPath(profile, area, duration) {
            showNotification(
                'Ruta Guardada',
                'La ruta de aprendizaje ha sido guardada correctamente.',
                'success'
            );
        }
        
        // Export generated path
        function exportGeneratedPath(profile, area, duration) {
            // Create file name
            const fileName = `Ruta_${getProfileLabel(profile).replace(/\s+/g, '_')}_${area === 'all' ? 'TodasAreas' : area.replace(/\s+/g, '_')}_${duration}meses.pdf`;
            
            showNotification(
                'Ruta Exportada',
                `La ruta de aprendizaje ha sido exportada como "${fileName}".`,
                'success'
            );
        }
        
        // Get profile label
        function getProfileLabel(profileValue) {
            const profiles = {
                'juez_paz': 'Juez/a de Paz',
                'juez_primera': 'Juez/a de Primera Instancia',
                'magistrado': 'Magistrado/a',
                'auxiliar': 'Personal Auxiliar',
                'administrativo': 'Personal Administrativo'
            };
            
            return profiles[profileValue] || profileValue;
        }
        
        // Format focus name
        function formatFocusName(focus) {
            switch(focus) {
                case 'practico': return 'Enfoque Práctico';
                case 'teorico': return 'Enfoque Teórico';
                case 'especializado': return 'Especialización';
                case 'integral': return 'Formación Integral';
                default: return focus;
            }
        }
        
        // Show notification
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationTitle = notification.querySelector('.notification-title');
            const notificationMessage = notification.querySelector('.notification-message');
            const notificationIcon = notification.querySelector('.notification-icon i');
            
            // Set content
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Set icon based on type
            notificationIcon.className = 'fas';
            switch (type) {
                case 'success':
                    notificationIcon.classList.add('fa-check-circle');
                    notification.style.borderLeftColor = 'var(--success)';
                    notificationIcon.style.color = 'var(--success)';
                    break;
                case 'warning':
                    notificationIcon.classList.add('fa-exclamation-triangle');
                    notification.style.borderLeftColor = 'var(--warning)';
                    notificationIcon.style.color = 'var(--warning)';
                    break;
                case 'error':
                    notificationIcon.classList.add('fa-times-circle');
                    notification.style.borderLeftColor = 'var(--danger)';
                    notificationIcon.style.color = 'var(--danger)';
                    break;
                default:
                    notificationIcon.classList.add('fa-info-circle');
                    notification.style.borderLeftColor = 'var(--primary)';
                    notificationIcon.style.color = 'var(--primary)';
            }
            
            // Show notification
            notification.classList.add('active');
            
            // Hide after duration
            setTimeout(() => {
                notification.classList.remove('active');
            }, 5000);
        }
        
        // Helper function to truncate text
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }



        function applyAdaptiveLayout(options = {}) {
            const defaultOptions = {
                type: 'semantic', // semantic, hierarchical, focus, cluster
                animationDuration: 800,
                focusNode: null,
                relationFilter: null
            };
            
            const config = {...defaultOptions, ...options};
            let layoutOptions = {};
            
            // Reset any previous visual states
            cy.elements().removeClass('highlighted faded semiFaded path');
            
            // Choose layout based on semantic context
            switch (config.type) {
                case 'semantic':
                    // Group by node type - courses, competencies, concepts, etc.
                    layoutOptions = {
                        name: 'cose-bilkent',
                        nodeRepulsion: 5500,
                        idealEdgeLength: function(edge) {
                            // Make related concepts closer together
                            if (edge.source().data('type') === edge.target().data('type')) {
                                return 75;
                            }
                            return 120;
                        },
                        edgeElasticity: 0.45,
                        nestingFactor: 0.1,
                        gravity: 0.3,
                        gravityRangeCompound: 1.5,
                        gravityCompound: 1.0,
                        gravityRange: 5.0,
                        // Initialize position based on node type
                        initialPositions: function(node) {
                            const type = node.data('type');
                            const nodeTypes = ['course', 'competency', 'concept', 'normative'];
                            const typeIndex = nodeTypes.indexOf(type);
                            
                            if (typeIndex >= 0) {
                                const angle = (2 * Math.PI * typeIndex) / nodeTypes.length;
                                const radius = 300;
                                return {
                                    x: radius * Math.cos(angle) + (Math.random() * 100 - 50),
                                    y: radius * Math.sin(angle) + (Math.random() * 100 - 50)
                                };
                            }
                            return null;
                        },
                        animate: true,
                        animationDuration: config.animationDuration,
                        randomize: false,
                        fit: true
                    };
                    break;
                    
                case 'hierarchical':
                    // Organize by hierarchical relationships
                    layoutOptions = {
                        name: 'dagre',
                        rankDir: 'TB',
                        rankSep: 100,
                        nodeSep: 50,
                        edgeSep: 10,
                        ranker: 'network-simplex',
                        minLen: function(edge) {
                            // Adjust edge length based on edge type
                            const edgeType = edge.data('label');
                            if (edgeType === 'desarrolla') return 2;
                            if (edgeType === 'apoya') return 1;
                            if (edgeType === 'incluye') return 1;
                            if (edgeType === 'reguladoPor') return 3;
                            return 1;
                        },
                        animate: true,
                        animationDuration: config.animationDuration
                    };
                    break;
                    
                case 'focus':
                    // Focus on a specific node and its relationships
                    if (!config.focusNode) {
                        console.error('Focus layout requires a focusNode parameter');
                        return;
                    }
                    
                    // Get neighborhood with configurable depth
                    const neighborhood = getNeighborhoodWithDepth(config.focusNode, 2);
                    
                    // Highlight the focused neighborhood
                    cy.elements().addClass('semiFaded');
                    neighborhood.removeClass('semiFaded');
                    config.focusNode.addClass('highlighted');
                    
                    layoutOptions = {
                        name: 'concentric',
                        concentric: function(node) {
                            if (node.id() === config.focusNode.id()) return 10;
                            
                            // First level neighbors
                            if (config.focusNode.neighborhood().contains(node)) return 8;
                            
                            // Second level neighbors
                            if (getNeighborhoodWithDepth(config.focusNode, 2).contains(node)) return 6;
                            
                            // Others
                            return 1;
                        },
                        levelWidth: function(nodes) {
                            return 1;
                        },
                        minNodeSpacing: 50,
                        animate: true,
                        animationDuration: config.animationDuration,
                        fit: true
                    };
                    
                    // Only layout the neighborhood
                    neighborhood.layout(layoutOptions).run();
                    return; // Skip the default layout run
                    
                case 'relation':
                    // Group by relationship type
                    if (!config.relationFilter) {
                        console.error('Relation layout requires a relationFilter parameter');
                        return;
                    }
                    
                    // Filter edges by relation type
                    const filteredEdges = cy.edges(`[label = "${config.relationFilter}"]`);
                    const connectedNodes = filteredEdges.connectedNodes();
                    
                    // Highlight the filtered elements
                    cy.elements().addClass('semiFaded');
                    filteredEdges.removeClass('semiFaded');
                    connectedNodes.removeClass('semiFaded');
                    
                    layoutOptions = {
                        name: 'cose',
                        componentSpacing: 40,
                        nodeRepulsion: 9000,
                        edgeElasticity: 100,
                        nestingFactor: 5,
                        gravity: 30,
                        idealEdgeLength: 100,
                        animate: true,
                        animationDuration: config.animationDuration,
                        randomize: false,
                        fit: true
                    };
                    
                    // Apply layout to visible elements
                    cy.elements().not('.semiFaded').layout(layoutOptions).run();
                    return; // Skip the default layout run
                    
                case 'cluster':
                    // Cluster by node attributes (level, area, etc.)
                    layoutOptions = {
                        name: 'cose',
                        componentSpacing: 40,
                        nodeRepulsion: function(node) {
                            // Nodes of same type repel less
                            return 4500;
                        },
                        edgeElasticity: function(edge) {
                            // Edges between same type nodes have higher elasticity
                            const sourceType = edge.source().data('type');
                            const targetType = edge.target().data('type');
                            if (sourceType === targetType) return 20;
                            return 100;
                        },
                        gravity: 80,
                        animate: true,
                        animationDuration: config.animationDuration,
                        fit: true
                    };
                    break;
            }
            
            // Apply the layout
            cy.layout(layoutOptions).run();
            
            // Show notification
            showNotification(
                'Diseño aplicado',
                `Se ha aplicado el diseño ${config.type} a la visualización.`,
                'info'
            );
        }


        function getNeighborhoodWithDepth(node, depth) {
            let neighborhood = node;
            let currentDepth = 0;
            
            while (currentDepth < depth) {
                neighborhood = neighborhood.union(neighborhood.neighborhood());
                currentDepth++;
            }
            
            return neighborhood;
        }

        // Add layout controls to the UI
        function addSemanticLayoutControls() {
            const layoutControls = document.querySelector('.layout-controls');
            
            if (!layoutControls) return;
            
            // Create semantic layout dropdown
            const semanticLayoutSelect = document.createElement('select');
            semanticLayoutSelect.id = 'semantic-layout-select';
            semanticLayoutSelect.className = 'ml-2 p-1 border border-gray-300 rounded text-sm';
            semanticLayoutSelect.innerHTML = `
                <option value="" disabled selected>Diseño semántico</option>
                <option value="semantic">Por tipo de nodo</option>
                <option value="hierarchical">Jerárquico</option>
                <option value="cluster">Por atributos</option>
            `;
            
            // Create relation filter dropdown
            const relationFilterSelect = document.createElement('select');
            relationFilterSelect.id = 'relation-filter-select';
            relationFilterSelect.className = 'ml-2 p-1 border border-gray-300 rounded text-sm';
            relationFilterSelect.innerHTML = `
                <option value="" disabled selected>Filtrar por relación</option>
                <option value="desarrolla">Desarrolla</option>
                <option value="apoya">Apoya</option>
                <option value="incluye">Incluye</option>
                <option value="reguladoPor">Regulado por</option>
            `;
            
            // Add to layout controls
            layoutControls.appendChild(semanticLayoutSelect);
            layoutControls.appendChild(relationFilterSelect);
            
            // Add event listeners
            semanticLayoutSelect.addEventListener('change', function() {
                if (!this.value) return;
                applyAdaptiveLayout({ type: this.value });
            });
            
            relationFilterSelect.addEventListener('change', function() {
                if (!this.value) return;
                applyAdaptiveLayout({ type: 'relation', relationFilter: this.value });
            });
        }

        // Call this during initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Add the semantic layout controls after initialization
            setTimeout(addSemanticLayoutControls, 2500);
        });




        // Add to your CSS
        const newStyles = `
            .path-highlight {
                width: 5px !important;
                line-color: #f59e0b !important;
                target-arrow-color: #f59e0b !important;
                z-index: 9999 !important;
                opacity: 1 !important;
                transition: width 0.3s, line-color 0.3s;
            }
            
            .path-start {
                border-color: #f59e0b !important;
                border-width: 4px !important;
                background-color: #fde68a !important;
            }
            
            .path-end {
                border-color: #059669 !important;
                border-width: 4px !important;
                background-color: #a7f3d0 !important;
            }
            
            .semiFaded {
                opacity: 0.25 !important;
            }
            
            .animation-pulse {
                animation: node-pulse 1.5s infinite;
            }
            
            @keyframes node-pulse {
                0% { border-width: 1px; }
                50% { border-width: 4px; }
                100% { border-width: 1px; }
            }
        `;

        // Insert the styles
        const styleSheet = document.createElement("style");
        styleSheet.innerText = newStyles;
        document.head.appendChild(styleSheet);

        // Intelligent zoom and path highlighting functions
        let pathStart = null;
        let pathEnd = null;

        // Focus on a semantic subgraph
        function focusOnSubgraph(node, depth = 1) {
            // Reset previous highlighting
            cy.elements().removeClass('highlighted faded semiFaded path path-highlight path-start path-end');
            
            // Get neighborhood with specified depth
            const neighborhood = getNeighborhoodWithDepth(node, depth);
            
            // Highlight neighborhood
            cy.elements().addClass('semiFaded');
            neighborhood.removeClass('semiFaded');
            node.addClass('highlighted');
            
            // Fit to the neighborhood with padding
            cy.fit(neighborhood, 50);
            
            // Apply a nice concentric layout to the neighborhood
            neighborhood.layout({
                name: 'concentric',
                concentric: function(n) {
                    if (n.id() === node.id()) return 10;
                    return 5;
                },
                levelWidth: function() { return 1; },
                animate: true
            }).run();
            
            // Show notification
            showNotification(
                'Subgrafo activado',
                `Mostrando el entorno semántico de "${node.data('name')}" con profundidad ${depth}.`,
                'info'
            );
        }

        // Highlight a semantic path between two nodes
        function highlightPath(startNode, endNode) {
            // Reset previous path
            cy.elements().removeClass('path path-highlight path-start path-end');
            
            // Calculate shortest path
            const dijkstra = cy.elements().dijkstra({
                root: startNode,
                directed: true
            });
            
            const path = dijkstra.pathTo(endNode);
            
            if (path.length === 0) {
                showNotification(
                    'Ruta no encontrada',
                    'No existe un camino entre los nodos seleccionados.',
                    'warning'
                );
                return;
            }
            
            // Highlight path
            path.addClass('path');
            path.edges().addClass('path-highlight');
            startNode.addClass('path-start');
            endNode.addClass('path-end');
            
            // Fit to the path with padding
            cy.fit(path, 50);
            
            // Show notification
            showNotification(
                'Ruta activada',
                `Se ha encontrado un camino semántico de longitud ${path.length} entre los nodos.`,
                'success'
            );
            
            // Animate the path
            animatePath(path);
        }

        // Animate a path sequentially
        function animatePath(path) {
            // Make all path elements semi-faded
            cy.elements().addClass('semiFaded');
            path.removeClass('semiFaded');
            
            // Get edges in order
            const edges = path.edges();
            const nodes = path.nodes();
            
            // Sequentially highlight
            let delay = 0;
            const interval = 300;
            
            // First highlight all nodes
            nodes.forEach((node, i) => {
                setTimeout(() => {
                    node.flashClass('animation-pulse', 1000);
                }, delay);
                delay += interval;
            });
            
            // Then highlight edges one by one
            delay = interval;
            edges.forEach((edge, i) => {
                setTimeout(() => {
                    edge.flashClass('animation-pulse', 1000);
                }, delay);
                delay += interval;
            });
        }

        // Add controls to UI
        function addPathControls() {
            const controlsOverlay = document.querySelector('.controls-overlay');
            
            if (!controlsOverlay) return;
            
            // Create path controls
            const pathControls = document.createElement('div');
            pathControls.className = 'mt-3 flex flex-wrap gap-1';
            pathControls.innerHTML = `
                <button class="control-button" id="start-path-btn">
                    <i class="fas fa-play-circle"></i> Iniciar ruta
                </button>
                <button class="control-button" id="end-path-btn" disabled>
                    <i class="fas fa-flag-checkered"></i> Finalizar ruta
                </button>
                <button class="control-button" id="cancel-path-btn" disabled>
                    <i class="fas fa-times-circle"></i> Cancelar
                </button>
                <button class="control-button" id="expand-node-btn">
                    <i class="fas fa-expand"></i> Expandir nodo
                </button>
            `;
            
            controlsOverlay.appendChild(pathControls);
            
            // Add event listeners
            document.getElementById('start-path-btn').addEventListener('click', function() {
                initializePathCreation();
            });
            
            document.getElementById('end-path-btn').addEventListener('click', function() {
                finalizePathCreation();
            });
            
            document.getElementById('cancel-path-btn').addEventListener('click', function() {
                cancelPathCreation();
            });
            
            document.getElementById('expand-node-btn').addEventListener('click', function() {
                const selectedNodes = cy.nodes('.highlighted');
                if (selectedNodes.length > 0) {
                    focusOnSubgraph(selectedNodes[0], 2);
                } else {
                    showNotification(
                        'No hay nodo seleccionado',
                        'Seleccione un nodo para expandir su contexto semántico.',
                        'warning'
                    );
                }
            });
            
            // Update existing click handler to support path creation
            cy.on('tap', 'node', function(e) {
                const node = e.target;
                
                // Check if we're in path creation mode
                if (pathStart && !pathEnd) {
                    // If this isn't the start node, set it as end
                    if (node.id() !== pathStart.id()) {
                        pathEnd = node;
                        node.addClass('path-end');
                        
                        // Enable end button
                        document.getElementById('end-path-btn').disabled = false;
                        
                        showNotification(
                            'Nodo final seleccionado',
                            'Haga clic en "Finalizar ruta" para visualizar el camino semántico.',
                            'info'
                        );
                    }
                } else {
                    // Regular node selection
                    highlightNode(node);
                    showNodeDetail(node);
                }
            });
        }

        // Initialize path creation mode
        function initializePathCreation() {
            // Reset any existing path
            cancelPathCreation();
            
            // Set in path creation mode
            cy.elements().removeClass('highlighted faded semiFaded');
            
            // Update UI
            document.getElementById('start-path-btn').disabled = true;
            document.getElementById('cancel-path-btn').disabled = false;
            
            // Show instructions
            showNotification(
                'Creación de ruta iniciada',
                'Seleccione el nodo inicial de la ruta semántica.',
                'info'
            );
            
            // Wait for node selection
            const nodeClickHandler = function(e) {
                const node = e.target;
                
                // Set as start node
                pathStart = node;
                node.addClass('path-start');
                
                // Show next instruction
                showNotification(
                    'Nodo inicial seleccionado',
                    'Ahora seleccione el nodo final de la ruta semántica.',
                    'info'
                );
                
                // Remove this handler to prevent multiple starts
                cy.removeListener('tap', 'node', nodeClickHandler);
            };
            
            // Add temporary node click handler
            cy.on('tap', 'node', nodeClickHandler);
        }

        // Finalize the path
        function finalizePathCreation() {
            if (!pathStart || !pathEnd) {
                showNotification(
                    'Error en creación de ruta',
                    'Debe seleccionar nodos de inicio y fin para la ruta.',
                    'error'
                );
                return;
            }
            
            // Highlight the path
            highlightPath(pathStart, pathEnd);
            
            // Reset UI
            document.getElementById('start-path-btn').disabled = false;
            document.getElementById('end-path-btn').disabled = true;
            document.getElementById('cancel-path-btn').disabled = true;
            
            // Keep path start and end for reference
        }

        // Cancel path creation
        function cancelPathCreation() {
            // Reset path variables
            pathStart = null;
            pathEnd = null;
            
            // Reset UI
            document.getElementById('start-path-btn').disabled = false;
            document.getElementById('end-path-btn').disabled = true;
            document.getElementById('cancel-path-btn').disabled = true;
            
            // Reset visuals
            cy.elements().removeClass('path path-highlight path-start path-end');
        }

        // Call this during initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Add path controls after initialization
            setTimeout(addPathControls, 2500);
        });
    </script>
</body>
</html>